<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EquipmentManager — Field Equipment Inventory</title>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: Inter, system-ui, sans-serif; background: #0b1220; color: #e2e8f0; }
    .layout { display: flex; flex-direction: column; min-height: 100vh; }
    header { padding: 18px 24px; border-bottom: 1px solid #22314f; background: #0f1a2e; }
    header h1 { margin: 0 0 4px; font-size: 1.25rem; }
    header p { margin: 0; color: #9fb0cc; font-size: 0.875rem; }
    main { flex: 1; padding: 20px 24px; max-width: 960px; width: 100%; margin: 0 auto; box-sizing: border-box; }

    .form-section { background: #0f1a2e; border: 1px solid #22314f; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
    .form-section h2 { margin: 0 0 16px; font-size: 1rem; color: #60a5fa; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group.full-width { grid-column: 1 / -1; }
    label { font-size: 0.8rem; color: #9fb0cc; font-weight: 500; }
    input, select { border: 1px solid #2a3f62; border-radius: 8px; background: #12203a; color: #e2e8f0; padding: 9px 11px; font-size: 0.875rem; font-family: inherit; }
    input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.25); }

    .toolbar { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .toolbar .search-wrap { flex: 1; min-width: 180px; }
    .toolbar .search-wrap input { width: 100%; box-sizing: border-box; }
    button { border: 1px solid #2a3f62; border-radius: 8px; background: #12203a; color: #e2e8f0; padding: 9px 14px; cursor: pointer; font-size: 0.85rem; font-family: inherit; }
    button:hover { background: #1a2d4a; }
    .primary { background: #2563eb; border-color: #3b82f6; }
    .primary:hover { background: #1d4ed8; }
    .danger { background: #7f1d1d; border-color: #dc2626; }
    .danger:hover { background: #991b1b; }

    .equip-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .equip-card { background: #0f1a2e; border: 1px solid #22314f; border-radius: 10px; padding: 16px; cursor: pointer; transition: border-color 0.15s; display: flex; gap: 16px; align-items: flex-start; }
    .equip-card:hover { border-color: #3b82f6; }
    .equip-icon { font-size: 2rem; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: #12203a; border-radius: 10px; flex-shrink: 0; }
    .equip-body { flex: 1; min-width: 0; }
    .equip-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; gap: 8px; }
    .equip-name { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .equip-details { display: flex; flex-wrap: wrap; gap: 6px 16px; font-size: 0.82rem; color: #9fb0cc; }
    .equip-details strong { color: #e2e8f0; font-weight: 500; }
    .equip-actions { display: flex; gap: 6px; margin-top: 10px; }

    .badge { display: inline-flex; align-items: center; gap: 5px; background: #1e3a5f; color: #60a5fa; border-radius: 6px; padding: 2px 8px; font-size: 0.75rem; font-weight: 600; }
    .badge svg { width: 14px; height: 14px; fill: currentColor; }
    .hidden { display: none; }

    .empty-state { text-align: center; padding: 60px 20px; color: #64748b; }
    .empty-state p { margin: 8px 0; }

    .export-bar { display: flex; gap: 8px; margin-top: 20px; padding-top: 16px; border-top: 1px solid #22314f; }

    .count-bar { font-size: 0.8rem; color: #9fb0cc; margin-bottom: 12px; }

    @media (max-width: 640px) {
      .form-grid { grid-template-columns: 1fr; }
      main { padding: 14px; }
      .equip-card { flex-direction: column; }
    }
  </style>
  <script type="module" src="/src/browser-localstorage-sync.js"></script>
</head>
<body>
  <div class="layout">
    <header>
      <h1>EquipmentManager</h1>
      <p>Track surveying equipment used by the field crew.</p>
    </header>

    <main>
      
      <div id="countBar" class="count-bar hidden"></div>

      <!-- Equipment List -->
      <div id="equipList" class="equip-list"></div>
      <div id="emptyState" class="empty-state hidden">
        <p><strong>No equipment tracked yet.</strong></p>
        <p>Add your first piece of equipment above.</p>
      </div>
      <!-- Entry Form -->
      <div id="formSection" class="form-section">
        <h2 id="formHeading">Add Equipment</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="make">Make</label>
            <input id="make" type="text" placeholder="e.g. Trimble" />
          </div>
          <div class="form-group">
            <label for="model">Model</label>
            <input id="model" type="text" placeholder="e.g. S7" />
          </div>
          <div class="form-group">
            <label for="equipmentType">Equipment Type</label>
            <select id="equipmentType">
              <option value="">Select…</option>
              <option value="GPS Rover">GPS Rover</option>
              <option value="GPS Base Station">GPS Base Station</option>
              <option value="Total Station">Total Station</option>
              <option value="Robotic Total Station">Robotic Total Station</option>
              <option value="Level">Level</option>
              <option value="Digital Level">Digital Level</option>
              <option value="Data Collector">Data Collector</option>
              <option value="Prism">Prism</option>
              <option value="Prism Pole">Prism Pole</option>
              <option value="Tripod">Tripod</option>
              <option value="Bipod">Bipod</option>
              <option value="Range Pole">Range Pole</option>
              <option value="Measuring Wheel">Measuring Wheel</option>
              <option value="Tape Measure">Tape Measure</option>
              <option value="Drone/UAV">Drone/UAV</option>
              <option value="Laser Scanner">Laser Scanner</option>
              <option value="Metal Detector">Metal Detector</option>
              <option value="Magnetic Locator">Magnetic Locator</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="serialNumber">Serial Number <span style="color:#64748b;">(optional)</span></label>
            <input id="serialNumber" type="text" placeholder="e.g. SN-58291034" />
          </div>
        </div>
        <div style="margin-top: 14px; display: flex; gap: 8px;">
          <button id="saveBtn" class="primary" type="button">Save</button>
          <button id="cancelBtn" type="button" class="hidden">Cancel</button>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="toolbar">
        <button id="newBtn" class="primary" type="button">+ Add Equipment</button>
        <div class="search-wrap">
          <input id="searchInput" type="text" placeholder="Search equipment…" />
        </div>
        <button id="exportCsvBtn" type="button">Export CSV</button>
        <button id="exportJsonBtn" type="button">Export JSON</button>
        <button id="clearAllBtn" class="danger" type="button">Clear All</button>
      </div>

    </main>
  </div>

  <script type="module">
    const STORAGE_KEY = 'surveyfoundryEquipmentInventory';

    /* ── equipment-type → icon SVG mapping ── */
    const TYPE_ICONS = {
      'GPS Rover':            `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a1 1 0 0 1 1 1v2.07A8.002 8.002 0 0 1 19.93 12H22a1 1 0 1 1 0 2h-2.07A8.002 8.002 0 0 1 13 20.93V23a1 1 0 1 1-2 0v-2.07A8.002 8.002 0 0 1 4.07 14H2a1 1 0 1 1 0-2h2.07A8.002 8.002 0 0 1 11 5.07V3a1 1 0 0 1 1-1Zm0 5a6 6 0 1 0 0 12 6 6 0 0 0 0-12Zm0 3a3 3 0 1 1 0 6 3 3 0 0 1 0-6Z"/></svg>`,
      'GPS Base Station':     `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a1 1 0 0 1 1 1v2.07A8.002 8.002 0 0 1 19.93 12H22a1 1 0 1 1 0 2h-2.07A8.002 8.002 0 0 1 13 20.93V23a1 1 0 1 1-2 0v-2.07A8.002 8.002 0 0 1 4.07 14H2a1 1 0 1 1 0-2h2.07A8.002 8.002 0 0 1 11 5.07V3a1 1 0 0 1 1-1Zm0 5a6 6 0 1 0 0 12 6 6 0 0 0 0-12Zm0 3a3 3 0 1 1 0 6 3 3 0 0 1 0-6Z"/></svg>`,
      'Total Station':        `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 1a2 2 0 0 1 2 2v1h1a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-1v1.27l4.18 6.96a1 1 0 0 1-.36 1.37 1 1 0 0 1-1.37-.36L13.38 14H10.62l-3.07 6.24a1 1 0 0 1-1.37.36 1 1 0 0 1-.36-1.37L10 12.27V12H9a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1V3a2 2 0 0 1 2-2Zm0 5a2 2 0 1 0 0 4 2 2 0 0 0 0-4Z"/></svg>`,
      'Robotic Total Station':`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 1a2 2 0 0 1 2 2v1h1a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-1v1.27l4.18 6.96a1 1 0 0 1-.36 1.37 1 1 0 0 1-1.37-.36L13.38 14H10.62l-3.07 6.24a1 1 0 0 1-1.37.36 1 1 0 0 1-.36-1.37L10 12.27V12H9a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1V3a2 2 0 0 1 2-2Zm0 5a2 2 0 1 0 0 4 2 2 0 0 0 0-4Z"/></svg>`,
      'Level':                `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2 9a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9Zm3 3a1 1 0 1 0 2 0 1 1 0 0 0-2 0Zm14 0a1 1 0 1 0 2 0 1 1 0 0 0-2 0Zm-9-1.5a1.5 1.5 0 0 0 0 3h4a1.5 1.5 0 0 0 0-3h-4Z"/></svg>`,
      'Digital Level':        `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2 9a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9Zm3 3a1 1 0 1 0 2 0 1 1 0 0 0-2 0Zm14 0a1 1 0 1 0 2 0 1 1 0 0 0-2 0Zm-9-1.5a1.5 1.5 0 0 0 0 3h4a1.5 1.5 0 0 0 0-3h-4Z"/></svg>`,
      'Data Collector':       `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7 2a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H7Zm1 3h8a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1Zm5 12a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>`,
      'Prism':                `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L3 20h18L12 2Zm0 5l5.5 11h-11L12 7Z"/></svg>`,
      'Prism Pole':           `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11 2h2v6l3-2.5V8l-3 2.5V22h-2V10.5L8 8V5.5L11 8V2Z"/></svg>`,
      'Tripod':               `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a2 2 0 0 1 2 2 2 2 0 0 1-.27 1H16a1 1 0 0 1 .97 1.24l-1.5 6A1 1 0 0 1 14.5 13h-.24l2.6 8.74a1 1 0 1 1-1.92.56L12.18 14h-.36l-2.76 8.3a1 1 0 1 1-1.9-.6L9.74 13h-.24a1 1 0 0 1-.97-.76l-1.5-6A1 1 0 0 1 8 5h2.27A2 2 0 0 1 10 4a2 2 0 0 1 2-2Z"/></svg>`,
      'Bipod':                `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11 2h2v8.28l4.95 10.9a1 1 0 1 1-1.82.82L12 12.38 7.87 22a1 1 0 1 1-1.82-.82L11 10.28V2Z"/></svg>`,
      'Range Pole':           `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11 1h2v4h1a1 1 0 0 1 0 2h-1v4h1a1 1 0 0 1 0 2h-1v4h1a1 1 0 0 1 0 2h-1v4h-2v-4H10a1 1 0 0 1 0-2h1v-4H10a1 1 0 0 1 0-2h1V7H10a1 1 0 0 1 0-2h1V1Z"/></svg>`,
      'Measuring Wheel':      `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a8 8 0 0 1 8 8 8 8 0 0 1-7 7.93V21h3a1 1 0 1 1 0 2H8a1 1 0 1 1 0-2h3v-3.07A8 8 0 0 1 12 2Zm0 3a5 5 0 1 0 0 10 5 5 0 0 0 0-10Zm0 2a3 3 0 1 1 0 6 3 3 0 0 1 0-6Z"/></svg>`,
      'Tape Measure':         `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H4Zm1 4h2v2H5V8Zm4 0h2v3H9V8Zm4 0h2v2h-2V8Zm4 0h2v3h-2V8Z"/></svg>`,
      'Drone/UAV':            `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3.5 5.5a2.5 2.5 0 0 1 5 0 2.5 2.5 0 0 1-1.75 2.38L7 9h10l.25-1.12A2.5 2.5 0 1 1 20.5 5.5a2.5 2.5 0 0 1-2.25 2.49L18 9.5a2 2 0 0 1-2 2h-1v1l3.25 1.12A2.5 2.5 0 1 1 20.5 16a2.5 2.5 0 0 1-2.03-1.05L15 13.87V14a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1v-.13l-3.47 1.08A2.5 2.5 0 1 1 3.5 16a2.5 2.5 0 0 1 2.25-2.49L9 12.5v-1H8a2 2 0 0 1-2-2l-.25-1.49A2.5 2.5 0 0 1 3.5 5.5Z"/></svg>`,
      'Laser Scanner':        `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a3 3 0 0 1 3 3v1h2a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-2v1.27l3.6 5.4a1 1 0 0 1-1.66 1.1L14 18.13h-4l-2.94 4.64a1 1 0 0 1-1.66-1.1L9 16.27V16H7a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2V5a3 3 0 0 1 3-3Zm-2 8H8v2h2v-2Zm6 0h-2v2h2v-2Zm-3-1a1 1 0 1 0-2 0v4a1 1 0 1 0 2 0V9Z"/></svg>`,
      'Metal Detector':       `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15 2a1 1 0 0 1 .86.5l2 3.46a1 1 0 0 1-.06 1.04l-1.22 1.63A6 6 0 0 1 13 20.92V22a1 1 0 1 1-2 0v-1.08A6 6 0 0 1 7.42 8.63L6.2 7a1 1 0 0 1-.06-1.04l2-3.46A1 1 0 0 1 9 2h6Zm-3 8a3 3 0 1 0 0 6 3 3 0 0 0 0-6Z"/></svg>`,
      'Magnetic Locator':     `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11 1h2v5h3l-4 5-4-5h3V1Zm1 11a3 3 0 0 1 3 3c0 1.3-.84 2.4-2 2.83V23h-2v-5.17A3.001 3.001 0 0 1 12 12Z"/></svg>`,
    };

    const DEFAULT_ICON = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a2 2 0 0 1 2 2v2h4a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4V4a2 2 0 0 1 2-2Zm0 8a3 3 0 1 0 0 6 3 3 0 0 0 0-6Z"/></svg>`;

    function iconForType(type) {
      return TYPE_ICONS[type] || DEFAULT_ICON;
    }

    /* ── DOM refs ── */
    const fields = {
      make: document.getElementById('make'),
      model: document.getElementById('model'),
      equipmentType: document.getElementById('equipmentType'),
      serialNumber: document.getElementById('serialNumber'),
    };

    const formHeading  = document.getElementById('formHeading');
    const saveBtn      = document.getElementById('saveBtn');
    const cancelBtn    = document.getElementById('cancelBtn');
    const newBtn       = document.getElementById('newBtn');
    const searchInput  = document.getElementById('searchInput');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportJsonBtn= document.getElementById('exportJsonBtn');
    const clearAllBtn  = document.getElementById('clearAllBtn');
    const equipListEl  = document.getElementById('equipList');
    const emptyStateEl = document.getElementById('emptyState');
    const countBarEl   = document.getElementById('countBar');

    // API config
    const EQUIPMENT_API_URL = '/api/equipment';

    let items = [];
    let editingId = null;
    let searchTerm = '';

    /* ── persistence ── */
    function loadItems() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        items = raw ? JSON.parse(raw) : [];
      } catch { items = []; }
    }

    function saveItems() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    /* ── API helpers ── */
    function mergeById(localList, serverList) {
      const out = new Map();
      for (const item of (localList || [])) {
        if (item && item.id) out.set(item.id, item);
      }
      for (const item of (serverList || [])) {
        if (item && item.id) out.set(item.id, { ...(out.get(item.id) || {}), ...item });
      }
      return Array.from(out.values());
    }

    function normalizeServerEquipmentList(json) {
      if (Array.isArray(json)) return json;
      if (Array.isArray(json?.equipment)) return json.equipment;
      if (Array.isArray(json?.data)) return json.data;
      return null;
    }

    function normalizeServerEquipmentItem(json) {
      if (json && typeof json === 'object') {
        if (json.equipment && typeof json.equipment === 'object' && json.equipment.id) return json.equipment;
        if (json.data && typeof json.data === 'object') return json.data;
        if (json.id) return json;
      }
      return null;
    }

    async function postEquipmentItem(item) {
      const res = await fetch(EQUIPMENT_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(item),
      });
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`POST ${EQUIPMENT_API_URL} failed (${res.status}) ${text}`.trim());
      }
      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) return null;
      return await res.json();
    }


    async function deleteEquipmentItemById(id) {
      const res = await fetch(`${EQUIPMENT_API_URL}?id=${encodeURIComponent(id)}`, {
        method: 'DELETE',
      });
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`DELETE ${EQUIPMENT_API_URL}?id=${encodeURIComponent(id)} failed (${res.status}) ${text}`.trim());
      }
      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) return null;
      return await res.json();
    }

    /* ── helpers ── */
    function esc(v = '') {
      return String(v).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
    }

    function clearForm() {
      Object.values(fields).forEach(el => { el.value = ''; });
      editingId = null;
      formHeading.textContent = 'Add Equipment';
      cancelBtn.classList.add('hidden');
    }

    function populateForm(item) {
      fields.make.value          = item.make || '';
      fields.model.value         = item.model || '';
      fields.equipmentType.value = item.equipmentType || '';
      fields.serialNumber.value  = item.serialNumber || '';
      editingId = item.id;
      formHeading.textContent = 'Edit Equipment';
      cancelBtn.classList.remove('hidden');
      fields.make.focus();
    }

    function filtered() {
      if (!searchTerm) return items;
      const q = searchTerm.toLowerCase();
      return items.filter(i =>
        (i.make || '').toLowerCase().includes(q) ||
        (i.model || '').toLowerCase().includes(q) ||
        (i.equipmentType || '').toLowerCase().includes(q) ||
        (i.serialNumber || '').toLowerCase().includes(q)
      );
    }

    /* ── render ── */
    function render() {
      const list = filtered();

      if (items.length === 0) {
        equipListEl.innerHTML = '';
        emptyStateEl.classList.remove('hidden');
        countBarEl.classList.add('hidden');
        return;
      }

      emptyStateEl.classList.add('hidden');
      countBarEl.classList.remove('hidden');
      countBarEl.textContent = searchTerm
        ? `Showing ${list.length} of ${items.length} items`
        : `${items.length} item${items.length === 1 ? '' : 's'}`;

      if (list.length === 0) {
        equipListEl.innerHTML = '<div class="empty-state"><p>No matches found.</p></div>';
        return;
      }

      const sorted = [...list].sort((a, b) => {
        const ta = (a.equipmentType || '').localeCompare(b.equipmentType || '');
        if (ta !== 0) return ta;
        return (a.make || '').localeCompare(b.make || '');
      });

      equipListEl.innerHTML = sorted.map(item => `
        <div class="equip-card" data-id="${item.id}">
          <div class="equip-icon" title="${esc(item.equipmentType || 'Equipment')}">${iconForType(item.equipmentType)}</div>
          <div class="equip-body">
            <div class="equip-header">
              <span class="equip-name">${esc(item.make)}${item.model ? ' ' + esc(item.model) : ''}</span>
              ${item.equipmentType ? `<span class="badge">${iconForType(item.equipmentType)}${esc(item.equipmentType)}</span>` : ''}
            </div>
            <div class="equip-details">
              <div><strong>Make:</strong> ${esc(item.make) || '—'}</div>
              <div><strong>Model:</strong> ${esc(item.model) || '—'}</div>
              ${item.serialNumber ? `<div><strong>S/N:</strong> ${esc(item.serialNumber)}</div>` : ''}
            </div>
            <div class="equip-actions">
              <button class="edit-btn" data-id="${item.id}" type="button">Edit</button>
              <button class="delete-btn danger" data-id="${item.id}" type="button">Delete</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    /* ── events ── */
    saveBtn.addEventListener('click', async () => {
      const make = fields.make.value.trim();
      const model = fields.model.value.trim();
      const equipmentType = fields.equipmentType.value;
      const serialNumber = fields.serialNumber.value.trim();

      if (!make && !model) { fields.make.focus(); return; }

      const nowIso = new Date().toISOString();
      const wasEditing = !!editingId;

      // UI lock
      const prevText = saveBtn.textContent;
      saveBtn.disabled = true;
      saveBtn.textContent = wasEditing ? 'Saving…' : 'Saving & Syncing…';

      try {
        if (wasEditing) {
          const idx = items.findIndex(i => i.id === editingId);
          if (idx !== -1) {
            items[idx] = { ...items[idx], make, model, equipmentType, serialNumber, updatedAt: nowIso };
          }
          saveItems();
          clearForm();
          render();
          return;
        }

        // NEW item: create local record first (fast)
        const localId = crypto.randomUUID();
        const newLocal = {
          id: localId,
          make, model, equipmentType, serialNumber,
          createdAt: nowIso,
          updatedAt: nowIso,
        };
        items.push(newLocal);
        saveItems();
        clearForm();
        render();

        // Then POST to API
        try {
          const apiJson = await postEquipmentItem(newLocal);

          const serverList = normalizeServerEquipmentList(apiJson);
          if (serverList) {
            items = mergeById(items, serverList);
            saveItems();
            render();
            return;
          }

          const serverItem = normalizeServerEquipmentItem(apiJson);
          if (serverItem && serverItem.id) {
            const localIdx = items.findIndex(i => i.id === localId);
            if (localIdx !== -1) {
              if (serverItem.id !== localId) {
                const merged = { ...items[localIdx], ...serverItem };
                items.splice(localIdx, 1);
                items.push(merged);
              } else {
                items[localIdx] = { ...items[localIdx], ...serverItem };
              }
              saveItems();
              render();
            }
          }
        } catch (err) {
          console.warn('Equipment POST failed; kept local copy:', err);
        }
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = prevText;
      }
    });

    cancelBtn.addEventListener('click', clearForm);

    newBtn.addEventListener('click', () => { clearForm(); fields.make.focus(); });

    searchInput.addEventListener('input', () => {
      searchTerm = searchInput.value.trim();
      render();
    });

    equipListEl.addEventListener('click', e => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      const id = target.dataset.id;
      if (!id) return;

      if (target.classList.contains('edit-btn')) {
        const item = items.find(i => i.id === id);
        if (item) populateForm(item);
      } else if (target.classList.contains('delete-btn')) {
        const prevItems = [...items];
        items = items.filter(i => i.id !== id);
        saveItems();
        if (editingId === id) clearForm();
        render();

        deleteEquipmentItemById(id).catch(err => {
          console.warn('Equipment DELETE failed; restoring local record:', err);
          items = prevItems;
          saveItems();
          render();
        });
      }
    });

    clearAllBtn.addEventListener('click', async () => {
      if (!confirm('Delete all equipment records? This cannot be undone.')) return;
      const prevItems = [...items];
      items = [];
      saveItems();
      clearForm();
      render();

      try {
        await Promise.all(prevItems.map((item) => deleteEquipmentItemById(item.id)));
      } catch (err) {
        console.warn('Bulk equipment DELETE failed; restoring local records:', err);
        items = prevItems;
        saveItems();
        render();
      }
    });

    exportCsvBtn.addEventListener('click', () => {
      if (items.length === 0) return;
      const headers = ['Make', 'Model', 'Equipment Type', 'Serial Number', 'Created At'];
      const rows = items.map(i => [i.make, i.model, i.equipmentType, i.serialNumber, i.createdAt]
        .map(v => `"${String(v || '').replace(/"/g, '""')}"`).join(','));
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url;
      a.download = `equipment-inventory-${new Date().toISOString().slice(0, 10)}.csv`;
      a.click(); URL.revokeObjectURL(url);
    });

    exportJsonBtn.addEventListener('click', () => {
      if (items.length === 0) return;
      const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url;
      a.download = `equipment-inventory-${new Date().toISOString().slice(0, 10)}.json`;
      a.click(); URL.revokeObjectURL(url);
    });

    window.addEventListener('surveyfoundry-localstorage-sync', () => {
      loadItems();
      render();
    });

    async function fetchLatestFromApi() {
      try {
        const res = await fetch(EQUIPMENT_API_URL);
        if (!res.ok) return;
        const data = await res.json();
        const serverItems = Array.isArray(data?.equipment) ? data.equipment : [];
        if (serverItems.length === 0) return;

        // Merge instead of replacing (prevents wiping local-only items)
        items = mergeById(items, serverItems);
        saveItems();
        render();
      } catch {
        // API unavailable, continue with localStorage data.
      }
    }

    /* ── init ── */
    loadItems();
    render();
    fetchLatestFromApi();
  </script>
</body>
</html>

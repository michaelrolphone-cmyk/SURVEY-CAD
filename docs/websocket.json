{
  "openapi": "3.1.0",
  "info": {
    "title": "SURVEY-CAD WebSocket API",
    "version": "1.0.0",
    "description": "WebSocket endpoints for SURVEY-CAD. Note: OpenAPI does not natively model WebSocket message flows; this spec represents each WS endpoint as an HTTP GET upgrade (101) plus vendor extensions (x-websocket) that document JSON message shapes and direction."
  },
  "servers": [
    {
      "url": "ws://0.0.0.0:3000",
      "description": "Default WebSocket base URL"
    },
    {
      "url": "wss://{host}:{port}",
      "description": "Secure WebSocket base URL",
      "variables": {
        "host": {
          "default": "localhost"
        },
        "port": {
          "default": "3000"
        }
      }
    }
  ],
  "tags": [
    {
      "name": "LineForge",
      "description": "Real-time collaborative drawing, cursors, locks, AR presence."
    },
    {
      "name": "LocalStorageSync",
      "description": "Differential key-value state synchronization."
    },
    {
      "name": "CrewPresence",
      "description": "Online crew member tracking."
    },
    {
      "name": "Worker",
      "description": "Distributed background worker task queue."
    },
    {
      "name": "LMProxy",
      "description": "LM Studio proxy hub for AI chat relay."
    }
  ],
  "paths": {
    "/ws/lineforge": {
      "get": {
        "tags": [
          "LineForge"
        ],
        "summary": "LineForge collaboration WebSocket",
        "description": "Upgrade to a WebSocket for real-time multi-user collaboration.\n\n- Query param: room (default \"default\")\n- Auth: none\n- Unrecognized paths return 404\n\nServer sends `welcome` immediately after connect (full room state).",
        "parameters": [
          {
            "name": "room",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "default": "default"
            },
            "description": "Collaboration room identifier."
          }
        ],
        "responses": {
          "101": {
            "description": "Switching Protocols (WebSocket upgrade)."
          },
          "400": {
            "description": "Bad Request (invalid upgrade / invalid query params)."
          },
          "404": {
            "description": "Not Found (unrecognized WebSocket path)."
          }
        },
        "x-websocket": {
          "encoding": "json-text",
          "direction": "bidirectional",
          "constants": {
            "lockTimeoutMs": 300000,
            "lockSweepIntervalMs": 60000,
            "userColorPalette": [
              "#ff4d4f",
              "#40a9ff",
              "#73d13d",
              "#9254de",
              "#fa8c16",
              "#13c2c2",
              "#eb2f96",
              "#fadb14"
            ]
          },
          "messages": {
            "serverToClient": {
              "$ref": "#/components/schemas/LineForgeServerMessage"
            },
            "clientToServer": {
              "$ref": "#/components/schemas/LineForgeClientMessage"
            }
          }
        }
      }
    },
    "/ws/localstorage-sync": {
      "get": {
        "tags": [
          "LocalStorageSync"
        ],
        "summary": "LocalStorage sync WebSocket",
        "description": "Upgrade to a WebSocket for differential key-value store synchronization.\n\n- Auth: none\n- Server sends `sync-welcome` immediately after connect (full state snapshot).",
        "responses": {
          "101": {
            "description": "Switching Protocols (WebSocket upgrade)."
          },
          "400": {
            "description": "Bad Request (invalid upgrade)."
          },
          "404": {
            "description": "Not Found (unrecognized WebSocket path)."
          }
        },
        "x-websocket": {
          "encoding": "json-text",
          "direction": "bidirectional",
          "messages": {
            "serverToClient": {
              "$ref": "#/components/schemas/LocalStorageSyncServerMessage"
            },
            "clientToServer": {
              "$ref": "#/components/schemas/LocalStorageSyncClientMessage"
            }
          },
          "wellKnownKeys": [
            "surveyfoundryCrewProfiles",
            "surveyfoundryEquipmentInventory",
            "surveyfoundryEquipmentLogs"
          ],
          "checksum": {
            "algorithm": "fnv1a-32",
            "format": "fnv1a-{hex8}",
            "canonicalization": "sort keys asc; coerce values to string; JSON.stringify; hash UTF-16 code units"
          }
        }
      }
    },
    "/ws/crew-presence": {
      "get": {
        "tags": [
          "CrewPresence"
        ],
        "summary": "Crew presence WebSocket",
        "description": "Upgrade to a WebSocket that tracks which crew members are currently online.\n\n- Auth: none\n- Server sends `crew-presence-welcome` immediately after connect.\n- Client should send `crew-presence-identify` to associate the connection with a crew member id (can change identity later).",
        "responses": {
          "101": {
            "description": "Switching Protocols (WebSocket upgrade)."
          },
          "400": {
            "description": "Bad Request (invalid upgrade)."
          },
          "404": {
            "description": "Not Found (unrecognized WebSocket path)."
          }
        },
        "x-websocket": {
          "encoding": "json-text",
          "direction": "bidirectional",
          "messages": {
            "serverToClient": {
              "$ref": "#/components/schemas/CrewPresenceServerMessage"
            },
            "clientToServer": {
              "$ref": "#/components/schemas/CrewPresenceClientMessage"
            }
          }
        }
      }
    },
    "/ws/worker": {
      "get": {
        "tags": [
          "Worker"
        ],
        "summary": "Worker task scheduler WebSocket",
        "description": "Upgrade to a WebSocket for distributed task dispatch to background workers.\n\nHandshake:\n1) Worker connects\n2) Worker MUST send `hello` as the first message\n3) Server replies `welcome`\n4) Server sends `ping` heartbeats; worker replies `pong`\n5) Server dispatches `task` messages; worker replies `task-result`\n\n- Query param: pool (default \"default\")\n- Auth: none",
        "parameters": [
          {
            "name": "pool",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "default": "default"
            },
            "description": "Worker pool identifier."
          }
        ],
        "responses": {
          "101": {
            "description": "Switching Protocols (WebSocket upgrade)."
          },
          "400": {
            "description": "Bad Request (invalid upgrade / invalid pool)."
          },
          "404": {
            "description": "Not Found (unrecognized WebSocket path)."
          }
        },
        "x-websocket": {
          "encoding": "json-text",
          "direction": "bidirectional",
          "constants": {
            "heartbeatIntervalMs": 10000,
            "offlineAfterMs": 30000
          },
          "messages": {
            "serverToClient": {
              "$ref": "#/components/schemas/WorkerServerMessage"
            },
            "clientToServer": {
              "$ref": "#/components/schemas/WorkerClientMessage"
            }
          },
          "x-write-guard": {
            "description": "Implementation detail: socket write guard wraps raw JSON writes into WS text frames and closes with 1002 on apparent HTTP writes."
          }
        }
      }
    },
    "/ws/lmproxy": {
      "get": {
        "tags": [
          "LMProxy"
        ],
        "summary": "LM proxy hub WebSocket",
        "description": "Upgrade to a WebSocket hub that routes UI chat requests to connected proxy backends.\n\nAuth:\n- Optional token via `token` query param or `x-control-token` header.\n- Required only if server CONTROL_TOKEN is configured.\n\nHandshake:\n1) Server sends `server_hello`\n2) Client MUST send `hello` with `client_id` (and role/capabilities)\n3) Server replies `hello_ack`\n4) Messages sent before `hello` receive `error`.\n\nMessage routing:\n- UI client sends `chat`/`models`/`cancel`.\n- Proxy client emits `started`/`delta`/`chunk`/`done`/`error`/`models`/`cancelled` with matching `id`; hub forwards to originating UI.",
        "parameters": [
          {
            "name": "token",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Control token (required only if server CONTROL_TOKEN is set)."
          }
        ],
        "security": [
          {
            "ControlTokenQuery": []
          },
          {
            "ControlTokenHeader": []
          },
          {}
        ],
        "responses": {
          "101": {
            "description": "Switching Protocols (WebSocket upgrade)."
          },
          "401": {
            "description": "Unauthorized (token required/invalid when CONTROL_TOKEN is enabled)."
          },
          "403": {
            "description": "Forbidden (token invalid)."
          },
          "404": {
            "description": "Not Found (unrecognized WebSocket path)."
          }
        },
        "x-websocket": {
          "encoding": "json-text",
          "direction": "bidirectional",
          "constants": {
            "pingIntervalMs": 25000,
            "requestTimeoutMs": 120000,
            "maxPayloadBytes": 10485760
          },
          "messages": {
            "serverToClient": {
              "$ref": "#/components/schemas/LMProxyServerMessage"
            },
            "clientToServer": {
              "$ref": "#/components/schemas/LMProxyClientMessage"
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "ControlTokenQuery": {
        "type": "apiKey",
        "in": "query",
        "name": "token",
        "description": "Control token passed as query param (used only when server CONTROL_TOKEN is enabled)."
      },
      "ControlTokenHeader": {
        "type": "apiKey",
        "in": "header",
        "name": "x-control-token",
        "description": "Control token passed as HTTP header (used only when server CONTROL_TOKEN is enabled)."
      }
    },
    "schemas": {
      "Uuid": {
        "type": "string",
        "description": "UUID string.",
        "examples": [
          "550e8400-e29b-41d4-a716-446655440000"
        ]
      },
      "TimestampMs": {
        "type": "integer",
        "description": "Milliseconds since epoch.",
        "examples": [
          1739664000000
        ]
      },
      "JsonValue": {
        "description": "Arbitrary JSON value."
      },
      "Peer": {
        "type": "object",
        "required": [
          "clientId",
          "color"
        ],
        "properties": {
          "clientId": {
            "$ref": "#/components/schemas/Uuid"
          },
          "color": {
            "$ref": "#/components/schemas/HexColor"
          }
        },
        "additionalProperties": false
      },
      "HexColor": {
        "type": "string",
        "description": "Hex color string.",
        "pattern": "^#[0-9a-fA-F]{6}$",
        "examples": [
          "#40a9ff"
        ]
      },
      "CursorPosition": {
        "type": "object",
        "required": [
          "x",
          "y"
        ],
        "properties": {
          "x": {
            "type": "number"
          },
          "y": {
            "type": "number"
          }
        },
        "additionalProperties": false
      },
      "LockEntityType": {
        "type": "string",
        "enum": [
          "point",
          "line"
        ]
      },
      "LockAction": {
        "type": "string",
        "enum": [
          "locked",
          "released"
        ]
      },
      "LockDeniedReason": {
        "type": "string",
        "enum": [
          "already-locked",
          "invalid-entity"
        ]
      },
      "Lock": {
        "type": "object",
        "required": [
          "entityType",
          "entityId",
          "ownerClientId",
          "ownerColor"
        ],
        "properties": {
          "entityType": {
            "$ref": "#/components/schemas/LockEntityType"
          },
          "entityId": {
            "type": "string",
            "minLength": 1
          },
          "ownerClientId": {
            "$ref": "#/components/schemas/Uuid"
          },
          "ownerColor": {
            "$ref": "#/components/schemas/HexColor"
          }
        },
        "additionalProperties": false
      },
      "ARPresence": {
        "type": "object",
        "description": "AR presence payload. All fields are optional; non-finite numeric fields are omitted from broadcasts.",
        "properties": {
          "x": {
            "type": "number"
          },
          "y": {
            "type": "number"
          },
          "lat": {
            "type": "number"
          },
          "lon": {
            "type": "number"
          },
          "altFeet": {
            "type": "number"
          },
          "headingRad": {
            "type": "number"
          },
          "pitchRad": {
            "type": "number"
          },
          "rollRad": {
            "type": "number"
          }
        },
        "additionalProperties": false
      },
      "LineForgeServerMessage": {
        "oneOf": [
          {
            "$ref": "#/components/schemas/LineForgeWelcome"
          },
          {
            "$ref": "#/components/schemas/LineForgePeerJoined"
          },
          {
            "$ref": "#/components/schemas/LineForgePeerLeft"
          },
          {
            "$ref": "#/components/schemas/LineForgeCursorBroadcast"
          },
          {
            "$ref": "#/components/schemas/LineForgeStateBroadcast"
          },
          {
            "$ref": "#/components/schemas/LineForgeStateAck"
          },
          {
            "$ref": "#/components/schemas/LineForgeStateRejected"
          },
          {
            "$ref": "#/components/schemas/LineForgeLockGranted"
          },
          {
            "$ref": "#/components/schemas/LineForgeLockDenied"
          },
          {
            "$ref": "#/components/schemas/LineForgeLockUpdated"
          },
          {
            "$ref": "#/components/schemas/LineForgeARPresenceBroadcast"
          },
          {
            "$ref": "#/components/schemas/LineForgePointForgeImport"
          },
          {
            "$ref": "#/components/schemas/LineforgeFieldToFinishUpdatedMessage"
          }
        ],
        "discriminator": {
          "propertyName": "type"
        },
        "description": "Server \u2192 client messages for /ws/lineforge."
      },
      "LineForgeClientMessage": {
        "oneOf": [
          {
            "$ref": "#/components/schemas/LineForgeCursorSend"
          },
          {
            "$ref": "#/components/schemas/LineForgeStateSend"
          },
          {
            "$ref": "#/components/schemas/LineForgeLockRequest"
          },
          {
            "$ref": "#/components/schemas/LineForgeLockRelease"
          },
          {
            "$ref": "#/components/schemas/LineForgeARPresenceSend"
          }
        ],
        "discriminator": {
          "propertyName": "type"
        },
        "description": "Client \u2192 server messages for /ws/lineforge."
      },
      "LineForgeWelcome": {
        "type": "object",
        "required": [
          "type",
          "clientId",
          "color",
          "peers",
          "state",
          "revision",
          "locks"
        ],
        "properties": {
          "type": {
            "const": "welcome"
          },
          "clientId": {
            "$ref": "#/components/schemas/Uuid"
          },
          "color": {
            "$ref": "#/components/schemas/HexColor"
          },
          "peers": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/Peer"
            }
          },
          "state": {
            "$ref": "#/components/schemas/JsonValue"
          },
          "revision": {
            "type": "integer",
            "minimum": 0
          },
          "locks": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/Lock"
            }
          }
        },
        "additionalProperties": true
      },
      "LineForgePeerJoined": {
        "type": "object",
        "required": [
          "type",
          "clientId",
          "color"
        ],
        "properties": {
          "type": {
            "const": "peer-joined"
          },
          "clientId": {
            "$ref": "#/components/schemas/Uuid"
          },
          "color": {
            "$ref": "#/components/schemas/HexColor"
          }
        },
        "additionalProperties": true
      },
      "LineForgePeerLeft": {
        "type": "object",
        "required": [
          "type",
          "clientId"
        ],
        "properties": {
          "type": {
            "const": "peer-left"
          },
          "clientId": {
            "$ref": "#/components/schemas/Uuid"
          }
        },
        "additionalProperties": true
      },
      "LineForgeCursorBroadcast": {
        "type": "object",
        "required": [
          "type",
          "clientId",
          "color",
          "cursor",
          "at"
        ],
        "properties": {
          "type": {
            "const": "cursor"
          },
          "clientId": {
            "$ref": "#/components/schemas/Uuid"
          },
          "color": {
            "$ref": "#/components/schemas/HexColor"
          },
          "cursor": {
            "$ref": "#/components/schemas/CursorPosition"
          },
          "crewMemberId": {
            "type": [
              "string",
              "null"
            ]
          },
          "crewName": {
            "type": [
              "string",
              "null"
            ]
          },
          "at": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "LineForgeStateBroadcast": {
        "type": "object",
        "required": [
          "type",
          "clientId",
          "state",
          "revision",
          "at"
        ],
        "properties": {
          "type": {
            "const": "state"
          },
          "clientId": {
            "$ref": "#/components/schemas/Uuid"
          },
          "state": {
            "$ref": "#/components/schemas/JsonValue"
          },
          "revision": {
            "type": "integer",
            "minimum": 0
          },
          "requestId": {
            "type": "string"
          },
          "at": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "LineForgeStateAck": {
        "type": "object",
        "required": [
          "type",
          "requestId",
          "revision",
          "state",
          "at"
        ],
        "properties": {
          "type": {
            "const": "state-ack"
          },
          "requestId": {
            "type": "string"
          },
          "revision": {
            "type": "integer",
            "minimum": 0
          },
          "state": {
            "$ref": "#/components/schemas/JsonValue"
          },
          "at": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "LineForgeStateRejected": {
        "type": "object",
        "required": [
          "type",
          "requestId",
          "reason",
          "expectedRevision",
          "state",
          "revision",
          "at"
        ],
        "properties": {
          "type": {
            "const": "state-rejected"
          },
          "requestId": {
            "type": "string"
          },
          "reason": {
            "const": "revision-mismatch"
          },
          "expectedRevision": {
            "type": "integer",
            "minimum": 0
          },
          "state": {
            "$ref": "#/components/schemas/JsonValue"
          },
          "revision": {
            "type": "integer",
            "minimum": 0
          },
          "at": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "LineForgeLockGranted": {
        "type": "object",
        "required": [
          "type",
          "requestId",
          "entityType",
          "entityId",
          "ownerClientId",
          "ownerColor",
          "at"
        ],
        "properties": {
          "type": {
            "const": "lock-granted"
          },
          "requestId": {
            "type": "string"
          },
          "entityType": {
            "$ref": "#/components/schemas/LockEntityType"
          },
          "entityId": {
            "type": "string",
            "minLength": 1
          },
          "ownerClientId": {
            "$ref": "#/components/schemas/Uuid"
          },
          "ownerColor": {
            "$ref": "#/components/schemas/HexColor"
          },
          "at": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "LineForgeLockDenied": {
        "type": "object",
        "required": [
          "type",
          "requestId",
          "reason",
          "entityType",
          "entityId",
          "ownerClientId",
          "ownerColor",
          "at"
        ],
        "properties": {
          "type": {
            "const": "lock-denied"
          },
          "requestId": {
            "type": "string"
          },
          "reason": {
            "$ref": "#/components/schemas/LockDeniedReason"
          },
          "entityType": {
            "$ref": "#/components/schemas/LockEntityType"
          },
          "entityId": {
            "type": "string",
            "minLength": 1
          },
          "ownerClientId": {
            "$ref": "#/components/schemas/Uuid"
          },
          "ownerColor": {
            "$ref": "#/components/schemas/HexColor"
          },
          "at": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "LineForgeLockUpdated": {
        "type": "object",
        "required": [
          "type",
          "action",
          "entityType",
          "entityId",
          "ownerClientId",
          "ownerColor",
          "at"
        ],
        "properties": {
          "type": {
            "const": "lock-updated"
          },
          "action": {
            "$ref": "#/components/schemas/LockAction"
          },
          "reason": {
            "type": "string",
            "description": "Present when released due to timeout (reason: \"timeout\")."
          },
          "entityType": {
            "$ref": "#/components/schemas/LockEntityType"
          },
          "entityId": {
            "type": "string",
            "minLength": 1
          },
          "ownerClientId": {
            "$ref": "#/components/schemas/Uuid"
          },
          "ownerColor": {
            "$ref": "#/components/schemas/HexColor"
          },
          "at": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "LineForgeARPresenceBroadcast": {
        "type": "object",
        "required": [
          "type",
          "clientId",
          "color",
          "presence",
          "at"
        ],
        "properties": {
          "type": {
            "const": "ar-presence"
          },
          "clientId": {
            "$ref": "#/components/schemas/Uuid"
          },
          "color": {
            "$ref": "#/components/schemas/HexColor"
          },
          "presence": {
            "$ref": "#/components/schemas/ARPresence"
          },
          "at": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "LineForgePointForgeImport": {
        "type": "object",
        "required": [
          "type",
          "exportId",
          "at"
        ],
        "properties": {
          "type": {
            "const": "pointforge-import"
          },
          "exportId": {
            "type": "string"
          },
          "at": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "LineForgeCursorSend": {
        "type": "object",
        "required": [
          "type",
          "cursor"
        ],
        "properties": {
          "type": {
            "const": "cursor"
          },
          "cursor": {
            "$ref": "#/components/schemas/CursorPosition"
          },
          "crewMemberId": {
            "type": "string"
          },
          "crewName": {
            "type": "string"
          }
        },
        "additionalProperties": true
      },
      "LineForgeStateSend": {
        "type": "object",
        "required": [
          "type",
          "state",
          "baseRevision"
        ],
        "properties": {
          "type": {
            "const": "state"
          },
          "state": {
            "$ref": "#/components/schemas/JsonValue"
          },
          "baseRevision": {
            "type": "integer",
            "minimum": 0
          },
          "requestId": {
            "type": "string"
          }
        },
        "additionalProperties": true
      },
      "LineForgeLockRequest": {
        "type": "object",
        "required": [
          "type",
          "entityType",
          "entityId"
        ],
        "properties": {
          "type": {
            "const": "lock-request"
          },
          "entityType": {
            "$ref": "#/components/schemas/LockEntityType"
          },
          "entityId": {
            "type": "string",
            "minLength": 1
          },
          "requestId": {
            "type": "string"
          }
        },
        "additionalProperties": true
      },
      "LineForgeLockRelease": {
        "type": "object",
        "required": [
          "type",
          "entityType",
          "entityId"
        ],
        "properties": {
          "type": {
            "const": "lock-release"
          },
          "entityType": {
            "$ref": "#/components/schemas/LockEntityType"
          },
          "entityId": {
            "type": "string",
            "minLength": 1
          }
        },
        "additionalProperties": true
      },
      "LineForgeARPresenceSend": {
        "type": "object",
        "required": [
          "type",
          "presence"
        ],
        "properties": {
          "type": {
            "const": "ar-presence"
          },
          "presence": {
            "$ref": "#/components/schemas/ARPresence"
          }
        },
        "additionalProperties": true
      },
      "LocalStorageSyncServerMessage": {
        "oneOf": [
          {
            "$ref": "#/components/schemas/SyncWelcome"
          },
          {
            "$ref": "#/components/schemas/SyncAck"
          },
          {
            "$ref": "#/components/schemas/SyncChecksumMismatch"
          },
          {
            "$ref": "#/components/schemas/SyncDifferentialApplied"
          }
        ],
        "discriminator": {
          "propertyName": "type"
        },
        "description": "Server \u2192 client messages for /ws/localstorage-sync."
      },
      "LocalStorageSyncClientMessage": {
        "oneOf": [
          {
            "$ref": "#/components/schemas/SyncDifferential"
          },
          {
            "$ref": "#/components/schemas/SyncDifferentialBatch"
          }
        ],
        "discriminator": {
          "propertyName": "type"
        },
        "description": "Client \u2192 server messages for /ws/localstorage-sync."
      },
      "SyncStateFull": {
        "type": "object",
        "required": [
          "version",
          "snapshot",
          "checksum",
          "updatedAt"
        ],
        "properties": {
          "version": {
            "type": "integer",
            "minimum": 0
          },
          "snapshot": {
            "type": "object",
            "description": "Key-value snapshot; values are strings.",
            "additionalProperties": {
              "type": "string"
            }
          },
          "checksum": {
            "type": "string"
          },
          "updatedAt": {
            "type": [
              "string",
              "null"
            ],
            "format": "date-time"
          },
          "pointFileSummary": {
            "type": "object",
            "description": "Project-grouped point-file summaries returned in place of full point-file version-history snapshot records.",
            "additionalProperties": {
              "type": "array",
              "items": {
                "$ref": "#/components/schemas/ProjectPointFileSummary"
              }
            }
          }
        },
        "additionalProperties": false
      },
      "ProjectPointFileSummary": {
        "type": "object",
        "required": [
          "pointFileId",
          "pointFileName",
          "exportFormat",
          "createdAt",
          "updatedAt",
          "latestVersionId",
          "versionCount",
          "source",
          "sourceLabel"
        ],
        "properties": {
          "pointFileId": { "type": "string" },
          "pointFileName": { "type": "string" },
          "exportFormat": { "type": "string" },
          "createdAt": { "type": ["string", "null"], "format": "date-time" },
          "updatedAt": { "type": ["string", "null"], "format": "date-time" },
          "latestVersionId": { "type": ["string", "null"] },
          "versionCount": { "type": "integer", "minimum": 0 },
          "source": { "type": ["string", "null"] },
          "sourceLabel": { "type": ["string", "null"] }
        },
        "additionalProperties": false
      },
      "SyncStateBrief": {
        "type": "object",
        "required": [
          "version",
          "checksum"
        ],
        "properties": {
          "version": {
            "type": "integer",
            "minimum": 0
          },
          "checksum": {
            "type": "string"
          }
        },
        "additionalProperties": true
      },
      "SyncWelcome": {
        "type": "object",
        "required": [
          "type",
          "clientId",
          "state"
        ],
        "properties": {
          "type": {
            "const": "sync-welcome"
          },
          "clientId": {
            "$ref": "#/components/schemas/Uuid"
          },
          "state": {
            "$ref": "#/components/schemas/SyncStateFull"
          }
        },
        "additionalProperties": true
      },
      "SyncAck": {
        "type": "object",
        "required": [
          "type",
          "requestId",
          "state"
        ],
        "properties": {
          "type": {
            "const": "sync-ack"
          },
          "requestId": {
            "type": "string"
          },
          "state": {
            "$ref": "#/components/schemas/SyncStateFull"
          }
        },
        "additionalProperties": true
      },
      "SyncChecksumMismatch": {
        "type": "object",
        "required": [
          "type",
          "requestId",
          "state"
        ],
        "properties": {
          "type": {
            "const": "sync-checksum-mismatch"
          },
          "requestId": {
            "type": "string"
          },
          "state": {
            "$ref": "#/components/schemas/SyncStateFull"
          }
        },
        "additionalProperties": true
      },
      "SyncDifferentialApplied": {
        "type": "object",
        "required": [
          "type",
          "requestId",
          "operations",
          "state"
        ],
        "properties": {
          "type": {
            "const": "sync-differential-applied"
          },
          "requestId": {
            "type": "string"
          },
          "originClientId": {
            "type": [
              "string",
              "null"
            ]
          },
          "operations": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/SyncOperation"
            }
          },
          "state": {
            "$ref": "#/components/schemas/SyncStateBrief"
          }
        },
        "additionalProperties": true
      },
      "SyncDifferential": {
        "type": "object",
        "required": [
          "type",
          "operations"
        ],
        "properties": {
          "type": {
            "const": "sync-differential"
          },
          "operations": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/SyncOperation"
            },
            "minItems": 1
          },
          "baseChecksum": {
            "type": "string",
            "description": "Expected server checksum for conflict detection; empty string to skip.",
            "default": ""
          },
          "requestId": {
            "type": "string"
          }
        },
        "additionalProperties": true
      },
      "SyncDiff": {
        "type": "object",
        "required": [
          "operations"
        ],
        "properties": {
          "operations": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/SyncOperation"
            },
            "minItems": 1
          }
        },
        "additionalProperties": true
      },
      "SyncDifferentialBatch": {
        "type": "object",
        "required": [
          "type",
          "diffs"
        ],
        "properties": {
          "type": {
            "const": "sync-differential-batch"
          },
          "diffs": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/SyncDiff"
            },
            "minItems": 1
          },
          "requestId": {
            "type": "string"
          }
        },
        "additionalProperties": true
      },
      "SyncOperation": {
        "oneOf": [
          {
            "$ref": "#/components/schemas/SyncSetOperation"
          },
          {
            "$ref": "#/components/schemas/SyncRemoveOperation"
          },
          {
            "$ref": "#/components/schemas/SyncClearOperation"
          }
        ],
        "discriminator": {
          "propertyName": "type"
        },
        "description": "Operation = set | remove | clear"
      },
      "SyncSetOperation": {
        "type": "object",
        "required": [
          "type",
          "key",
          "value"
        ],
        "properties": {
          "type": {
            "const": "set"
          },
          "key": {
            "type": "string",
            "minLength": 1
          },
          "value": {
            "type": "string"
          }
        },
        "additionalProperties": false
      },
      "SyncRemoveOperation": {
        "type": "object",
        "required": [
          "type",
          "key"
        ],
        "properties": {
          "type": {
            "const": "remove"
          },
          "key": {
            "type": "string",
            "minLength": 1
          }
        },
        "additionalProperties": false
      },
      "SyncClearOperation": {
        "type": "object",
        "required": [
          "type"
        ],
        "properties": {
          "type": {
            "const": "clear"
          }
        },
        "additionalProperties": false
      },
      "CrewPresenceServerMessage": {
        "oneOf": [
          {
            "$ref": "#/components/schemas/CrewPresenceWelcome"
          },
          {
            "$ref": "#/components/schemas/CrewPresenceUpdate"
          }
        ],
        "discriminator": {
          "propertyName": "type"
        }
      },
      "CrewPresenceClientMessage": {
        "oneOf": [
          {
            "$ref": "#/components/schemas/CrewPresenceIdentify"
          }
        ],
        "discriminator": {
          "propertyName": "type"
        }
      },
      "CrewPresenceWelcome": {
        "type": "object",
        "required": [
          "type",
          "clientId",
          "online"
        ],
        "properties": {
          "type": {
            "const": "crew-presence-welcome"
          },
          "clientId": {
            "$ref": "#/components/schemas/Uuid"
          },
          "online": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "additionalProperties": true
      },
      "CrewPresenceUpdate": {
        "type": "object",
        "required": [
          "type",
          "online"
        ],
        "properties": {
          "type": {
            "const": "crew-presence-update"
          },
          "online": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "additionalProperties": true
      },
      "CrewPresenceIdentify": {
        "type": "object",
        "required": [
          "type",
          "crewMemberId"
        ],
        "properties": {
          "type": {
            "const": "crew-presence-identify"
          },
          "crewMemberId": {
            "type": [
              "string",
              "null"
            ],
            "description": "Falsy (null/empty) to de-identify."
          }
        },
        "additionalProperties": true
      },
      "WorkerServerMessage": {
        "oneOf": [
          {
            "$ref": "#/components/schemas/WorkerWelcome"
          },
          {
            "$ref": "#/components/schemas/WorkerPing"
          },
          {
            "$ref": "#/components/schemas/WorkerTask"
          }
        ],
        "discriminator": {
          "propertyName": "type"
        }
      },
      "WorkerClientMessage": {
        "oneOf": [
          {
            "$ref": "#/components/schemas/WorkerHello"
          },
          {
            "$ref": "#/components/schemas/WorkerPong"
          },
          {
            "$ref": "#/components/schemas/WorkerTaskResult"
          }
        ],
        "discriminator": {
          "propertyName": "type"
        }
      },
      "WorkerWelcome": {
        "type": "object",
        "required": [
          "type",
          "workerId",
          "poolId",
          "heartbeatMs",
          "offlineAfterMs",
          "now"
        ],
        "properties": {
          "type": {
            "const": "welcome"
          },
          "workerId": {
            "type": "string"
          },
          "poolId": {
            "type": "string"
          },
          "heartbeatMs": {
            "type": "integer",
            "minimum": 1
          },
          "offlineAfterMs": {
            "type": "integer",
            "minimum": 1
          },
          "now": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "WorkerPing": {
        "type": "object",
        "required": [
          "type",
          "seq",
          "at"
        ],
        "properties": {
          "type": {
            "const": "ping"
          },
          "seq": {
            "type": "integer",
            "minimum": 0
          },
          "at": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "WorkerTask": {
        "type": "object",
        "required": [
          "type",
          "taskId",
          "kind",
          "payload",
          "createdAt"
        ],
        "properties": {
          "type": {
            "const": "task"
          },
          "taskId": {
            "$ref": "#/components/schemas/Uuid"
          },
          "kind": {
            "type": "string"
          },
          "payload": {
            "$ref": "#/components/schemas/JsonValue"
          },
          "createdAt": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "WorkerHello": {
        "type": "object",
        "required": [
          "type"
        ],
        "properties": {
          "type": {
            "const": "hello"
          },
          "workerId": {
            "type": "string",
            "description": "Desired worker id for reconnection support."
          },
          "name": {
            "type": [
              "string",
              "null"
            ],
            "maxLength": 120
          },
          "concurrency": {
            "type": "integer",
            "minimum": 1,
            "default": 1
          },
          "capabilities": {
            "type": [
              "object",
              "null"
            ],
            "additionalProperties": true
          }
        },
        "additionalProperties": true
      },
      "WorkerPong": {
        "type": "object",
        "required": [
          "type",
          "seq"
        ],
        "properties": {
          "type": {
            "const": "pong"
          },
          "seq": {
            "type": "integer",
            "minimum": 0
          }
        },
        "additionalProperties": true
      },
      "WorkerTaskResult": {
        "type": "object",
        "required": [
          "type",
          "taskId",
          "ok"
        ],
        "properties": {
          "type": {
            "const": "task-result"
          },
          "taskId": {
            "$ref": "#/components/schemas/Uuid"
          },
          "ok": {
            "type": "boolean"
          },
          "result": {
            "$ref": "#/components/schemas/JsonValue"
          },
          "error": {
            "description": "Error details (object with message preferred) or string.",
            "oneOf": [
              {
                "type": "string"
              },
              {
                "type": "object",
                "additionalProperties": true
              }
            ]
          }
        },
        "allOf": [
          {
            "if": {
              "properties": {
                "ok": {
                  "const": true
                }
              },
              "required": [
                "ok"
              ]
            },
            "then": {
              "required": [
                "result"
              ]
            }
          },
          {
            "if": {
              "properties": {
                "ok": {
                  "const": false
                }
              },
              "required": [
                "ok"
              ]
            },
            "then": {
              "required": [
                "error"
              ]
            }
          }
        ],
        "additionalProperties": true
      },
      "LMProxyServerMessage": {
        "oneOf": [
          {
            "$ref": "#/components/schemas/LMProxyServerHello"
          },
          {
            "$ref": "#/components/schemas/LMProxyHelloAck"
          },
          {
            "$ref": "#/components/schemas/LMProxyError"
          },
          {
            "$ref": "#/components/schemas/LMProxyPong"
          },
          {
            "$ref": "#/components/schemas/LMProxyProxyEventForwarded"
          }
        ],
        "discriminator": {
          "propertyName": "type"
        },
        "description": "Server \u2192 client messages for /ws/lmproxy. Includes forwarded proxy events to UI."
      },
      "LMProxyClientMessage": {
        "oneOf": [
          {
            "$ref": "#/components/schemas/LMProxyHello"
          },
          {
            "$ref": "#/components/schemas/LMProxyPing"
          },
          {
            "$ref": "#/components/schemas/LMProxyChat"
          },
          {
            "$ref": "#/components/schemas/LMProxyModelsRequest"
          },
          {
            "$ref": "#/components/schemas/LMProxyCancel"
          },
          {
            "$ref": "#/components/schemas/LMProxyProxyEventUpstream"
          }
        ],
        "discriminator": {
          "propertyName": "type"
        },
        "description": "Client \u2192 server messages for /ws/lmproxy. UI sends chat/models/cancel; proxy sends started/delta/chunk/done/error/models/cancelled."
      },
      "LMProxyServerHello": {
        "type": "object",
        "required": [
          "type",
          "want",
          "ts"
        ],
        "properties": {
          "type": {
            "const": "server_hello"
          },
          "want": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "examples": [
              [
                "hello"
              ]
            ]
          },
          "ts": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "LMProxyHelloAck": {
        "type": "object",
        "required": [
          "type",
          "client_id",
          "role",
          "ts"
        ],
        "properties": {
          "type": {
            "const": "hello_ack"
          },
          "client_id": {
            "type": "string",
            "minLength": 1
          },
          "role": {
            "type": "string",
            "description": "Typically 'ui' for UI clients; proxy clients may omit explicit role."
          },
          "ts": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "LMProxyError": {
        "type": "object",
        "required": [
          "type",
          "error"
        ],
        "properties": {
          "type": {
            "const": "error"
          },
          "id": {
            "type": "string",
            "description": "Request id if applicable."
          },
          "error": {
            "type": "object",
            "required": [
              "message"
            ],
            "properties": {
              "message": {
                "type": "string"
              }
            },
            "additionalProperties": true
          }
        },
        "additionalProperties": true
      },
      "LMProxyPong": {
        "type": "object",
        "required": [
          "type",
          "ts"
        ],
        "properties": {
          "type": {
            "const": "pong"
          },
          "ts": {
            "$ref": "#/components/schemas/TimestampMs"
          }
        },
        "additionalProperties": true
      },
      "LMProxyHello": {
        "type": "object",
        "required": [
          "type",
          "client_id"
        ],
        "properties": {
          "type": {
            "const": "hello"
          },
          "client_id": {
            "type": "string",
            "minLength": 1
          },
          "role": {
            "type": "string",
            "description": "Set to 'ui' for UI clients."
          },
          "capabilities": {
            "type": "object",
            "additionalProperties": true
          },
          "lm_base_url": {
            "type": "string"
          }
        },
        "additionalProperties": true
      },
      "LMProxyPing": {
        "type": "object",
        "required": [
          "type"
        ],
        "properties": {
          "type": {
            "const": "ping"
          }
        },
        "additionalProperties": true
      },
      "LMProxyChatBodyMessage": {
        "type": "object",
        "required": [
          "role",
          "content"
        ],
        "properties": {
          "role": {
            "type": "string",
            "enum": [
              "system",
              "user",
              "assistant"
            ]
          },
          "content": {
            "type": "string"
          }
        },
        "additionalProperties": true
      },
      "LMProxyChatBody": {
        "type": "object",
        "required": [
          "messages"
        ],
        "properties": {
          "messages": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/LMProxyChatBodyMessage"
            },
            "minItems": 1
          },
          "temperature": {
            "type": "number"
          },
          "max_tokens": {
            "type": "integer",
            "minimum": 1
          },
          "model": {
            "type": "string"
          },
          "stream": {
            "type": "boolean"
          }
        },
        "additionalProperties": true
      },
      "LMProxyChat": {
        "type": "object",
        "required": [
          "type",
          "id",
          "body"
        ],
        "properties": {
          "type": {
            "const": "chat"
          },
          "id": {
            "type": "string",
            "minLength": 1
          },
          "body": {
            "$ref": "#/components/schemas/LMProxyChatBody"
          }
        },
        "additionalProperties": true
      },
      "LMProxyModelsRequest": {
        "type": "object",
        "required": [
          "type",
          "id"
        ],
        "properties": {
          "type": {
            "const": "models"
          },
          "id": {
            "type": "string",
            "minLength": 1
          }
        },
        "additionalProperties": true
      },
      "LMProxyCancel": {
        "type": "object",
        "required": [
          "type",
          "id"
        ],
        "properties": {
          "type": {
            "const": "cancel"
          },
          "id": {
            "type": "string",
            "minLength": 1
          }
        },
        "additionalProperties": true
      },
      "LMProxyProxyEventForwarded": {
        "description": "Events forwarded from proxy to UI (server \u2192 client).",
        "oneOf": [
          {
            "$ref": "#/components/schemas/LMProxyStarted"
          },
          {
            "$ref": "#/components/schemas/LMProxyDelta"
          },
          {
            "$ref": "#/components/schemas/LMProxyChunk"
          },
          {
            "$ref": "#/components/schemas/LMProxyDone"
          },
          {
            "$ref": "#/components/schemas/LMProxyError"
          },
          {
            "$ref": "#/components/schemas/LMProxyModelsResponse"
          },
          {
            "$ref": "#/components/schemas/LMProxyCancelled"
          }
        ],
        "discriminator": {
          "propertyName": "type"
        }
      },
      "LMProxyProxyEventUpstream": {
        "description": "Proxy \u2192 hub messages that are routed/forwarded as appropriate (client \u2192 server).",
        "oneOf": [
          {
            "$ref": "#/components/schemas/LMProxyStarted"
          },
          {
            "$ref": "#/components/schemas/LMProxyDelta"
          },
          {
            "$ref": "#/components/schemas/LMProxyChunk"
          },
          {
            "$ref": "#/components/schemas/LMProxyDone"
          },
          {
            "$ref": "#/components/schemas/LMProxyError"
          },
          {
            "$ref": "#/components/schemas/LMProxyModelsResponse"
          },
          {
            "$ref": "#/components/schemas/LMProxyCancelled"
          }
        ],
        "discriminator": {
          "propertyName": "type"
        }
      },
      "LMProxyStarted": {
        "type": "object",
        "required": [
          "type",
          "id"
        ],
        "properties": {
          "type": {
            "const": "started"
          },
          "id": {
            "type": "string",
            "minLength": 1
          }
        },
        "additionalProperties": true
      },
      "LMProxyDelta": {
        "type": "object",
        "required": [
          "type",
          "id",
          "data"
        ],
        "properties": {
          "type": {
            "const": "delta"
          },
          "id": {
            "type": "string",
            "minLength": 1
          },
          "data": {
            "type": "string"
          }
        },
        "additionalProperties": true
      },
      "LMProxyChunk": {
        "type": "object",
        "required": [
          "type",
          "id",
          "data"
        ],
        "properties": {
          "type": {
            "const": "chunk"
          },
          "id": {
            "type": "string",
            "minLength": 1
          },
          "data": {
            "$ref": "#/components/schemas/JsonValue"
          }
        },
        "additionalProperties": true
      },
      "LMProxyDone": {
        "type": "object",
        "required": [
          "type",
          "id"
        ],
        "properties": {
          "type": {
            "const": "done"
          },
          "id": {
            "type": "string",
            "minLength": 1
          }
        },
        "additionalProperties": true
      },
      "LMProxyModelsResponse": {
        "type": "object",
        "required": [
          "type",
          "id",
          "data"
        ],
        "properties": {
          "type": {
            "const": "models"
          },
          "id": {
            "type": "string",
            "minLength": 1
          },
          "data": {
            "$ref": "#/components/schemas/JsonValue"
          }
        },
        "additionalProperties": true
      },
      "LMProxyCancelled": {
        "type": "object",
        "required": [
          "type",
          "id"
        ],
        "properties": {
          "type": {
            "const": "cancelled"
          },
          "id": {
            "type": "string",
            "minLength": 1
          }
        },
        "additionalProperties": true
      },
      "LineforgeFieldToFinishUpdatedMessage": {
        "type": "object",
        "properties": {
          "type": {
            "const": "field-to-finish-updated"
          },
          "updatedAt": {
            "type": "string",
            "format": "date-time"
          }
        },
        "required": [
          "type",
          "updatedAt"
        ],
        "additionalProperties": false
      }
    }
  },
  "x-notes": {
    "websocketUpgrade": "All endpoints use standard HTTP Upgrade: Upgrade: websocket, Connection: Upgrade, Sec-WebSocket-Key, Sec-WebSocket-Version.",
    "unrecognizedPaths": "Unrecognized WebSocket paths return HTTP/1.1 404 Not Found.",
    "implementationNote": "lineforge/localstorage-sync/crew-presence/worker use a hand-rolled WS implementation; lmproxy uses the ws npm package in noServer mode."
  }
}

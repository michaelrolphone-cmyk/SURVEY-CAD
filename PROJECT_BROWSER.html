<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EvidenceDesk</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b1220;
      --panel: #172033;
      --panel-alt: #1e293b;
      --border: rgba(148, 163, 184, 0.25);
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #38bdf8;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #1e293b 0%, var(--bg) 60%);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      min-height: 100vh;
      padding: 1rem;
    }

    .app-shell {
      margin: 0 auto;
      max-width: 920px;
      background: rgba(15, 23, 42, 0.72);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }

    header {
      padding: 0.95rem 1rem;
      border-bottom: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
    }

    h1 {
      margin: 0;
      font-size: 1.05rem;
    }

    .subtitle {
      margin: 0.3rem 0 0;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .content {
      padding: 1rem;
      display: grid;
      gap: 0.75rem;
    }

    .tree-root,
    .folder-row,
    .file-row {
      display: flex;
      align-items: center;
      gap: 0.55rem;
      border-radius: 8px;
      padding: 0.42rem 0.55rem;
    }

    .upload-panel {
      margin-left: 1.65rem;
      border: 1px dashed rgba(56, 189, 248, 0.45);
      border-radius: 10px;
      padding: 0.75rem;
      background: rgba(15, 23, 42, 0.5);
      display: grid;
      gap: 0.55rem;
    }

    .upload-panel.drag-active {
      border-color: #7dd3fc;
      background: rgba(14, 116, 144, 0.2);
    }

    .upload-actions {
      display: flex;
      gap: 0.55rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .upload-actions input[type="file"] {
      display: none;
    }

    .upload-status {
      font-size: 0.82rem;
      color: var(--muted);
      min-height: 1.1rem;
    }

    .tree-root,
    .folder-row {
      background: var(--panel);
      border: 1px solid var(--border);
    }

    .folder-row {
      margin-top: 0.45rem;
      background: var(--panel-alt);
      justify-content: space-between;
    }

    .folder-title {
      display: flex;
      align-items: center;
      gap: 0.55rem;
      min-width: 0;
    }

    .file-row {
      margin-left: 1.65rem;
      color: var(--muted);
      font-size: 0.86rem;
      justify-content: space-between;
      gap: 0.8rem;
    }

    .file-row.pointforge-openable {
      cursor: pointer;
      border: 1px solid transparent;
      transition: border-color 100ms ease, background-color 100ms ease;
    }

    .file-row.pointforge-openable:hover,
    .file-row.pointforge-openable:focus-visible {
      border-color: rgba(56, 189, 248, 0.45);
      background: rgba(30, 41, 59, 0.72);
      color: var(--text);
      outline: none;
    }

    .file-meta {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      min-width: 0;
    }

    .file-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .launch-btn {
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text);
      border-radius: 8px;
      padding: 0.25rem 0.55rem;
      font-size: 0.78rem;
      cursor: pointer;
      flex: none;
    }

    .launch-btn:hover {
      border-color: rgba(56, 189, 248, 0.5);
      color: #bae6fd;
    }

    .launch-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .icon {
      width: 1.2rem;
      text-align: center;
      flex: none;
    }

    .muted {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .empty {
      margin-left: 1.65rem;
      color: var(--muted);
      font-style: italic;
      font-size: 0.86rem;
    }

    .error {
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 10px;
      color: #fecaca;
      background: rgba(127, 29, 29, 0.24);
      padding: 0.75rem;
    }
  </style>
  <script type="module" src="/src/browser-localstorage-sync.js"></script>
</head>
<body>
  <div class="app-shell">
    <header>
      <h1>üìÅ SurveyFoundry EvidenceDesk</h1>
      <p class="subtitle" id="projectLabel">Loading active project‚Ä¶</p>
    </header>
    <section class="content" id="treeContainer"></section>
  </div>

  <script type="module">
    import { loadStoredProjectFile, saveStoredProjectFile, appendResourceToFolder, removeResourceById, findCpfPointLinksAsync } from './src/project-browser-state.js';

    const POINTFORGE_PROJECT_BROWSER_IMPORT_STORAGE_KEY = 'pointforgeProjectBrowserImport';
    const LINESMITH_PROJECT_BROWSER_DRAWING_IMPORT_STORAGE_KEY = 'lineSmithProjectBrowserDrawingImport';
    const ADA_CPF_PDF_BASE = 'https://gisprod.adacounty.id.gov/apps/acdscpf/CpfPdfs/';

    const projectLabel = document.getElementById('projectLabel');
    const treeContainer = document.getElementById('treeContainer');

    function openLinkedApp(path) {
      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({
            type: 'survey-cad:navigate-app',
            path,
          }, window.location.origin);
          return;
        }
      } catch {
        // If parent access is blocked, fallback to same-tab navigation.
      }
      window.location.assign(path);
    }

    async function resolvePointFileText(resource) {
      const ref = resource?.reference;
      if (!ref?.value) return null;

      if (ref.type === 'local-storage') {
        const raw = localStorage.getItem(ref.value);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        const text = parsed?.text;
        return typeof text === 'string' ? text : null;
      }

      if (ref.type === 'server-upload') {
        const response = await fetch(ref.value);
        if (!response.ok) return null;
        return await response.text();
      }

      return null;
    }

    function launchLineSmithFromDrawingResource(resource, projectContext = {}) {
      const storageKey = resource?.reference?.value;
      if (!storageKey) {
        renderError(`Selected drawing could not be opened. Missing storage key for ${resource?.title || 'resource'}.`);
        return;
      }

      localStorage.setItem(LINESMITH_PROJECT_BROWSER_DRAWING_IMPORT_STORAGE_KEY, JSON.stringify({
        storageKey,
        drawingName: resource.title || resource.id || 'Drawing',
      }));

      const destination = new URL('/VIEWPORT.HTML', window.location.origin);
      destination.searchParams.set('source', 'project-browser-drawing');
      if (projectContext.projectId) destination.searchParams.set('activeProjectId', projectContext.projectId);
      if (projectContext.projectName) destination.searchParams.set('activeProjectName', projectContext.projectName);
      openLinkedApp(`${destination.pathname}${destination.search}`);
    }

    async function launchPointForgeFromResource(resource, projectContext = {}) {
      const text = await resolvePointFileText(resource);
      if (!text || !text.trim()) {
        renderError(`Selected point file could not be opened. Unable to load text for ${resource?.title || 'resource'}.`);
        return;
      }

      localStorage.setItem(POINTFORGE_PROJECT_BROWSER_IMPORT_STORAGE_KEY, JSON.stringify({
        csv: text,
        title: resource.title || resource.id || 'Point File',
      }));

      const destination = new URL('/POINT_TRANSFORMER.HTML', window.location.origin);
      destination.searchParams.set('source', 'project-browser');
      if (projectContext.projectId) destination.searchParams.set('projectId', projectContext.projectId);
      if (projectContext.projectName) destination.searchParams.set('projectName', projectContext.projectName);
      openLinkedApp(`${destination.pathname}${destination.search}`);
    }

    function getCpfPdfUrl(resource) {
      const reference = resource?.reference || {};
      const metadata = reference.metadata || {};
      const metadataPdf = typeof metadata.pdfUrl === 'string' ? metadata.pdfUrl.trim() : '';
      const instrument = String(reference.value || metadata.instrument || '').trim();

      let remoteUrl = '';
      if (/^https?:\/\//i.test(metadataPdf)) {
        remoteUrl = metadataPdf;
      } else if (instrument) {
        remoteUrl = `${ADA_CPF_PDF_BASE}${encodeURIComponent(instrument)}.pdf`;
      }

      if (!remoteUrl) return '';

      const proxyUrl = new URL('/api/ros-pdf', window.location.origin);
      proxyUrl.searchParams.set('url', remoteUrl);
      return proxyUrl.toString();
    }

    function buildPrintPreviewPdfUrl(pdfUrl) {
      if (!pdfUrl) return '';
      // PDF Open Parameters hide most built-in viewer chrome and ask for fit-to-page scaling.
      // Browsers may ignore unsupported flags, but this prevents sidebar/tool UI in engines that support them.
      return `${pdfUrl}#toolbar=0&navpanes=0&scrollbar=0&view=Fit&zoom=page-fit`;
    }

    function openCpfPdfFromResource(resource) {
      const pdfUrl = getCpfPdfUrl(resource);
      if (!pdfUrl) {
        renderError(`Selected CP&F file could not be opened. Missing instrument number for ${resource?.title || 'resource'}.`);
        return;
      }
      window.open(pdfUrl, '_blank', 'noopener,noreferrer');
    }

    function describeCpfPointLinks(links = []) {
      if (!Array.isArray(links) || !links.length) return '';
      return links
        .map((link, index) => `${index + 1}. ${link.pointFileTitle} ‚Üí Point ${link.pointNumber} (${link.pointCode})`)
        .join('\n');
    }

    async function deleteCpfResource(folder, resource, projectContext) {
      const instrument = String(resource?.reference?.value || resource?.reference?.metadata?.instrument || '').trim();
      const links = await findCpfPointLinksAsync(projectContext?.projectFile, resolvePointFileText, instrument);
      let shouldDelete = true;
      if (links.length) {
        const detail = describeCpfPointLinks(links);
        shouldDelete = window.confirm(`This CP&F is linked to ${links.length} point${links.length === 1 ? '' : 's'}:\n\n${detail}\n\nDelete CP&F anyway?`);
      }
      if (!shouldDelete) return;

      const removed = removeResourceById(projectContext?.projectFile, folder?.key, resource?.id);
      if (!removed) {
        renderError(`Could not delete CP&F ${resource?.title || resource?.id || ''}.`);
        return;
      }

      const saved = saveStoredProjectFile(window.localStorage, projectContext?.activeProjectId, projectContext?.projectFile);
      if (!saved) {
        renderError('CP&F was removed in memory, but project snapshot could not be saved.');
        return;
      }

      const deletedTitle = resource?.title || resource?.id || instrument || 'CP&F record';
      projectContext.setUploadStatus(`Deleted ${deletedTitle}.`);
      renderTree(projectContext.projectFile, projectContext);
    }

    function escapeHtml(text = '') {
      return String(text)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function openCpfPrintPreview(resources = []) {
      const printableResources = resources
        .map((entry) => ({
          entry,
          url: getCpfPdfUrl(entry),
        }))
        .filter((item) => item.url);

      if (!printableResources.length) {
        renderError('No printable CP&F PDF records were found for this project.');
        return;
      }

      // Use a plain same-origin popup so browsers return a writable window handle.
      // Some engines return `null` when `noopener` is requested, which incorrectly
      // triggers our popup-blocked error path and leaves a blank preview tab.
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        renderError('Your browser blocked the print-preview window. Please allow pop-ups and try again.');
        return;
      }

      const pagesMarkup = printableResources.map(({ url }, index) => `
        <section class="page-block">
          <iframe src="${escapeHtml(buildPrintPreviewPdfUrl(url))}" title="CP&amp;F PDF ${index + 1}" class="pdf-frame"></iframe>
        </section>
      `).join('');

      printWindow.document.write(`<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CP&amp;F Print Preview</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: Inter, system-ui, sans-serif; margin: 1rem; color: #0f172a; background: #fff; }
    .toolbar { position: sticky; top: 0; background: #fff; padding: 0.5rem 0; margin-bottom: 1rem; border-bottom: 1px solid #cbd5e1; }
    .print-button { font: inherit; padding: 0.45rem 0.8rem; border-radius: 6px; border: 1px solid #334155; background: #fff; cursor: pointer; }
    .page-block { margin: 0 0 1rem; display: flex; justify-content: center; background: #fff; }
    .pdf-frame { width: min(100%, 8.5in); height: 98vh; border: 1px solid #94a3b8; border-radius: 8px; display: block; margin: 0 auto; background: #fff; }
    @media print {
      @page { margin: 0; }
      .toolbar { display: none; }
      body { margin: 0; background: #fff; }
      .page-block { margin: 0; break-inside: avoid; page-break-inside: avoid; display: flex; justify-content: center; background: #fff; }
      .pdf-frame { width: 100%; border: none; border-radius: 0; height: 100vh; background: #fff; }
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button type="button" class="print-button" onclick="window.print()">Print all CP&amp;F PDFs</button>
  </div>
  ${pagesMarkup}
</body>
</html>`);
      printWindow.document.close();
      printWindow.focus();
    }

    function loadActiveProjectContext(activeProjectId) {
      try {
        const projects = JSON.parse(localStorage.getItem('surveyfoundryProjects') || '[]');
        if (!Array.isArray(projects)) return null;
        return projects.find((project) => project.id === activeProjectId) || null;
      } catch {
        return null;
      }
    }

    function isSupportedPointFile(file) {
      const name = file?.name || '';
      return /\.(csv|txt)$/i.test(name);
    }

    async function uploadPointFilesToServer(files, context) {
      const accepted = Array.from(files || []).filter(isSupportedPointFile);
      if (!accepted.length) {
        context.setUploadStatus('No supported files found. Use .csv or .txt files.');
        return;
      }

      if (!context.activeProjectId || !context.projectFile) {
        context.setUploadStatus('Select an active project before uploading point files.');
        return;
      }

      let uploadedCount = 0;
      for (const file of accepted) {
        const formData = new FormData();
        formData.append('projectId', context.activeProjectId);
        formData.append('folderKey', 'point-files');
        formData.append('file', file, file.name);

        try {
          const response = await fetch('/api/project-files/upload', {
            method: 'POST',
            body: formData,
          });
          if (!response.ok) {
            const err = await response.json().catch(() => ({ error: 'Upload failed.' }));
            context.setUploadStatus(`Failed to upload ${file.name}: ${err.error}`);
            continue;
          }
          const { resource } = await response.json();
          const appended = appendResourceToFolder(context.projectFile, 'point-files', resource);
          if (appended) uploadedCount += 1;
        } catch (err) {
          context.setUploadStatus(`Network error uploading ${file.name}: ${err.message}`);
        }
      }

      if (!uploadedCount) {
        context.setUploadStatus('No point files were uploaded successfully.');
        return;
      }

      saveStoredProjectFile(window.localStorage, context.activeProjectId, context.projectFile);
      context.setUploadStatus(`Uploaded ${uploadedCount} point file${uploadedCount === 1 ? '' : 's'} to this project.`);
      renderTree(context.projectFile, context);
    }

    async function uploadFilesToServer(files, folderKey, context) {
      const fileList = Array.from(files || []);
      if (!fileList.length) {
        context.setUploadStatus('No files selected.');
        return;
      }
      if (!context.activeProjectId || !context.projectFile) {
        context.setUploadStatus('Select an active project before uploading files.');
        return;
      }
      if (!folderKey) {
        context.setUploadStatus('Please select a folder to upload into.');
        return;
      }

      let uploadedCount = 0;
      for (const file of fileList) {
        const formData = new FormData();
        formData.append('projectId', context.activeProjectId);
        formData.append('folderKey', folderKey);
        formData.append('file', file, file.name);

        try {
          const response = await fetch('/api/project-files/upload', {
            method: 'POST',
            body: formData,
          });
          if (!response.ok) {
            const err = await response.json().catch(() => ({ error: 'Upload failed.' }));
            context.setUploadStatus(`Failed to upload ${file.name}: ${err.error}`);
            continue;
          }
          const { resource } = await response.json();
          const appended = appendResourceToFolder(context.projectFile, folderKey, resource);
          if (appended) uploadedCount += 1;
        } catch (err) {
          context.setUploadStatus(`Network error uploading ${file.name}: ${err.message}`);
        }
      }

      if (!uploadedCount) {
        context.setUploadStatus('No files were uploaded successfully.');
        return;
      }

      saveStoredProjectFile(window.localStorage, context.activeProjectId, context.projectFile);
      context.setUploadStatus(`Uploaded ${uploadedCount} file${uploadedCount === 1 ? '' : 's'} to project.`);
      renderTree(context.projectFile, context);
    }

    function createFileUploadPanel(context) {
      const panel = document.createElement('div');
      panel.className = 'upload-panel';

      const title = document.createElement('div');
      title.className = 'muted';
      title.textContent = 'Upload files to the project: drag files here, or choose files below.';
      panel.appendChild(title);

      const actions = document.createElement('div');
      actions.className = 'upload-actions';

      const folderSelect = document.createElement('select');
      folderSelect.className = 'launch-btn';
      folderSelect.style.padding = '0.3rem 0.45rem';
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Select folder‚Ä¶';
      folderSelect.appendChild(defaultOption);
      for (const folder of context.projectFile?.folders || []) {
        const option = document.createElement('option');
        option.value = folder.key;
        option.textContent = folder.label;
        folderSelect.appendChild(option);
      }
      actions.appendChild(folderSelect);

      const picker = document.createElement('input');
      picker.type = 'file';
      picker.multiple = true;
      picker.style.display = 'none';
      picker.addEventListener('change', () => {
        if (picker.files.length) {
          uploadFilesToServer(picker.files, folderSelect.value, context);
        }
      });

      const pickerButton = document.createElement('button');
      pickerButton.type = 'button';
      pickerButton.className = 'launch-btn';
      pickerButton.textContent = 'Choose Files';
      pickerButton.addEventListener('click', () => {
        if (!folderSelect.value) {
          context.setUploadStatus('Please select a folder first.');
          const statusEl = panel.querySelector('.upload-status');
          if (statusEl) statusEl.textContent = context.uploadStatus;
          return;
        }
        picker.click();
      });

      actions.appendChild(pickerButton);
      actions.appendChild(picker);
      panel.appendChild(actions);

      const status = document.createElement('div');
      status.className = 'upload-status';
      status.textContent = context.uploadStatus || '';
      panel.appendChild(status);

      panel.addEventListener('dragover', (event) => {
        event.preventDefault();
        panel.classList.add('drag-active');
      });
      panel.addEventListener('dragleave', () => panel.classList.remove('drag-active'));
      panel.addEventListener('drop', (event) => {
        event.preventDefault();
        panel.classList.remove('drag-active');
        if (!folderSelect.value) {
          context.setUploadStatus('Please select a folder before dropping files.');
          const statusEl = panel.querySelector('.upload-status');
          if (statusEl) statusEl.textContent = context.uploadStatus;
          return;
        }
        uploadFilesToServer(event.dataTransfer?.files, folderSelect.value, context);
      });

      return panel;
    }

    function createPointFileUploadPanel(context) {
      const panel = document.createElement('div');
      panel.className = 'upload-panel';

      const title = document.createElement('div');
      title.className = 'muted';
      title.textContent = 'Attach point files (.csv or .txt): drag files here on desktop, or choose files on mobile.';
      panel.appendChild(title);

      const actions = document.createElement('div');
      actions.className = 'upload-actions';

      const picker = document.createElement('input');
      picker.type = 'file';
      picker.accept = '.csv,text/csv,.txt,text/plain';
      picker.multiple = true;
      picker.addEventListener('change', () => uploadPointFilesToServer(picker.files, context));

      const pickerButton = document.createElement('button');
      pickerButton.type = 'button';
      pickerButton.className = 'launch-btn';
      pickerButton.textContent = 'Choose Point Files';
      pickerButton.addEventListener('click', () => picker.click());

      actions.appendChild(pickerButton);
      actions.appendChild(picker);
      panel.appendChild(actions);

      const status = document.createElement('div');
      status.className = 'upload-status';
      status.textContent = context.uploadStatus || '';
      panel.appendChild(status);

      panel.addEventListener('dragover', (event) => {
        event.preventDefault();
        panel.classList.add('drag-active');
      });
      panel.addEventListener('dragleave', () => panel.classList.remove('drag-active'));
      panel.addEventListener('drop', (event) => {
        event.preventDefault();
        panel.classList.remove('drag-active');
        uploadPointFilesToServer(event.dataTransfer?.files, context);
      });

      return panel;
    }

    function renderTree(projectFile, projectContext = {}) {
      treeContainer.innerHTML = '';

      const root = document.createElement('div');
      root.className = 'tree-root';
      root.innerHTML = `<span class="icon">üóÇÔ∏è</span><strong>${projectFile.archive.rootFolderName}</strong><span class="muted">(symbolic root folder)</span>`;
      treeContainer.appendChild(root);

      treeContainer.appendChild(createFileUploadPanel(projectContext));

      for (const folder of projectFile.folders || []) {
        const folderRow = document.createElement('div');
        folderRow.className = 'folder-row';
        folderRow.innerHTML = `<span class="folder-title"><span class="icon">üìÅ</span><strong>${folder.label}</strong><span class="muted">${folder.description}</span></span>`;

        if (folder.key === 'cpfs') {
          const printAllButton = document.createElement('button');
          printAllButton.type = 'button';
          printAllButton.className = 'launch-btn';
          printAllButton.textContent = 'Print all';
          printAllButton.title = 'Builds a single print preview containing each CP&F PDF in order';
          printAllButton.addEventListener('click', () => openCpfPrintPreview(folder.index));
          printAllButton.disabled = !folder.index.some((entry) => entry?.exportFormat === 'pdf');
          folderRow.appendChild(printAllButton);
        }

        treeContainer.appendChild(folderRow);

        if (folder.key === 'point-files') {
          treeContainer.appendChild(createPointFileUploadPanel(projectContext));
        }

        if (!folder.index.length) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = 'No linked resources yet.';
          treeContainer.appendChild(empty);
          continue;
        }

        for (const entry of folder.index) {
          const resource = document.createElement('div');
          resource.className = 'file-row';

          const canLaunchPointForge = folder.key === 'point-files' && (entry?.reference?.type === 'local-storage' || entry?.reference?.type === 'server-upload');
          const canOpenLineSmithDrawing = folder.key === 'drawings' && entry?.reference?.type === 'local-storage';
          const canOpenCpfPdf = folder.key === 'cpfs' && entry?.exportFormat === 'pdf';
          resource.innerHTML = `<span class="file-meta"><span class="icon">üìÑ</span><span class="file-name">${entry.id}.${entry.exportFormat} <span class="muted">‚Äî ${entry.title}</span></span></span>`;

          if (canLaunchPointForge) {
            resource.classList.add('pointforge-openable');
            resource.setAttribute('role', 'button');
            resource.setAttribute('tabindex', '0');
            resource.title = 'Tap to open this point file in PointForge';
            resource.addEventListener('click', () => launchPointForgeFromResource(entry, projectContext));
            resource.addEventListener('keydown', (event) => {
              if (event.key !== 'Enter' && event.key !== ' ') return;
              event.preventDefault();
              launchPointForgeFromResource(entry, projectContext);
            });

            const openButton = document.createElement('button');
            openButton.type = 'button';
            openButton.className = 'launch-btn';
            openButton.textContent = 'Open in PointForge';
            openButton.title = 'Loads this point file into PointForge input';
            openButton.addEventListener('click', (event) => {
              event.stopPropagation();
              launchPointForgeFromResource(entry, projectContext);
            });
            resource.appendChild(openButton);

            const deletePointFileButton = document.createElement('button');
            deletePointFileButton.type = 'button';
            deletePointFileButton.className = 'launch-btn';
            deletePointFileButton.textContent = 'Delete';
            deletePointFileButton.title = 'Remove this point file from the project';
            deletePointFileButton.addEventListener('click', (event) => {
              event.stopPropagation();
              if (!window.confirm(`Remove "${entry.title}" from the project?`)) return;
              const removed = removeResourceById(projectContext?.projectFile, folder?.key, entry?.id);
              if (!removed) {
                renderError(`Could not remove ${entry?.title || entry?.id || 'point file'}.`);
                return;
              }
              saveStoredProjectFile(window.localStorage, projectContext?.activeProjectId, projectContext?.projectFile);
              projectContext.setUploadStatus(`Removed ${entry.title}.`);
              renderTree(projectContext.projectFile, projectContext);
            });
            resource.appendChild(deletePointFileButton);
          }

          if (canOpenLineSmithDrawing) {
            resource.classList.add('pointforge-openable');
            resource.setAttribute('role', 'button');
            resource.setAttribute('tabindex', '0');
            resource.title = 'Tap to open this drawing in LineSmith';
            resource.addEventListener('click', () => launchLineSmithFromDrawingResource(entry, projectContext));
            resource.addEventListener('keydown', (event) => {
              if (event.key !== 'Enter' && event.key !== ' ') return;
              event.preventDefault();
              launchLineSmithFromDrawingResource(entry, projectContext);
            });

            const openButton = document.createElement('button');
            openButton.type = 'button';
            openButton.className = 'launch-btn';
            openButton.textContent = 'Open in LineSmith';
            openButton.title = 'Loads this saved drawing into LineSmith';
            openButton.addEventListener('click', (event) => {
              event.stopPropagation();
              launchLineSmithFromDrawingResource(entry, projectContext);
            });
            resource.appendChild(openButton);
          }

          if (canOpenCpfPdf) {
            resource.classList.add('pointforge-openable');
            resource.setAttribute('role', 'button');
            resource.setAttribute('tabindex', '0');
            resource.title = 'Tap to open this CP&F PDF in a new tab';
            resource.addEventListener('click', () => openCpfPdfFromResource(entry));
            resource.addEventListener('keydown', (event) => {
              if (event.key !== 'Enter' && event.key !== ' ') return;
              event.preventDefault();
              openCpfPdfFromResource(entry);
            });

            const openButton = document.createElement('button');
            openButton.type = 'button';
            openButton.className = 'launch-btn';
            openButton.textContent = 'Open PDF';
            openButton.title = 'Opens this CP&F PDF in a new tab';
            openButton.addEventListener('click', (event) => {
              event.stopPropagation();
              openCpfPdfFromResource(entry);
            });
            resource.appendChild(openButton);

            const deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'launch-btn';
            deleteButton.textContent = 'Delete';
            deleteButton.title = 'Delete this CP&F from the project file';
            deleteButton.addEventListener('click', (event) => {
              event.stopPropagation();
              deleteCpfResource(folder, entry, projectContext);
            });
            resource.appendChild(deleteButton);
          }

          const isServerUpload = entry?.reference?.type === 'server-upload' && !canLaunchPointForge;
          if (isServerUpload) {
            const downloadUrl = entry.reference.value;
            resource.classList.add('pointforge-openable');
            resource.setAttribute('role', 'button');
            resource.setAttribute('tabindex', '0');
            resource.title = 'Click to open this file';
            resource.addEventListener('click', () => window.open(downloadUrl, '_blank', 'noopener,noreferrer'));
            resource.addEventListener('keydown', (event) => {
              if (event.key !== 'Enter' && event.key !== ' ') return;
              event.preventDefault();
              window.open(downloadUrl, '_blank', 'noopener,noreferrer');
            });

            const openButton = document.createElement('button');
            openButton.type = 'button';
            openButton.className = 'launch-btn';
            openButton.textContent = 'Open';
            openButton.title = 'Opens this file in a new tab';
            openButton.addEventListener('click', (event) => {
              event.stopPropagation();
              window.open(downloadUrl, '_blank', 'noopener,noreferrer');
            });
            resource.appendChild(openButton);

            const deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'launch-btn';
            deleteButton.textContent = 'Delete';
            deleteButton.title = 'Remove this file from the project';
            deleteButton.addEventListener('click', (event) => {
              event.stopPropagation();
              if (!window.confirm(`Remove "${entry.title}" from the project?`)) return;
              const removed = removeResourceById(projectContext?.projectFile, folder?.key, entry?.id);
              if (!removed) {
                renderError(`Could not remove ${entry?.title || entry?.id || 'file'}.`);
                return;
              }
              saveStoredProjectFile(window.localStorage, projectContext?.activeProjectId, projectContext?.projectFile);
              projectContext.setUploadStatus(`Removed ${entry.title}.`);
              renderTree(projectContext.projectFile, projectContext);
            });
            resource.appendChild(deleteButton);
          }

          treeContainer.appendChild(resource);
        }
      }

      const manifest = document.createElement('div');
      manifest.className = 'file-row';
      manifest.style.marginLeft = '0';
      manifest.innerHTML = '<span class="icon">üìÑ</span>project-file.json';
      treeContainer.appendChild(manifest);
    }

    function renderError(message) {
      treeContainer.innerHTML = `<div class="error">${message}</div>`;
    }

    async function initialize() {
      const params = new URLSearchParams(window.location.search);
      const activeProjectId = params.get('activeProjectId') || '';
      const activeProjectName = params.get('activeProjectName') || '';
      const activeProject = activeProjectId ? loadActiveProjectContext(activeProjectId) : null;
      const projectName = activeProject?.name || activeProjectName || 'Untitled Project';
      const client = activeProject?.client || '';
      const address = activeProject?.address || '';

      projectLabel.textContent = activeProjectId
        ? `Active project: ${projectName} (${activeProjectId})`
        : 'No active project selected. Showing a template project structure.';

      let uploadStatus = '';
      const projectContext = {
        activeProjectId,
        projectId: activeProjectId,
        projectName,
        projectFile: null,
        uploadStatus: '',
        setUploadStatus(message) {
          uploadStatus = message;
          this.uploadStatus = message;
        },
      };

      const storedProjectFile = loadStoredProjectFile(window.localStorage, activeProjectId);
      if (storedProjectFile) {
        projectContext.projectFile = storedProjectFile;
        projectContext.uploadStatus = uploadStatus;
        renderTree(storedProjectFile, projectContext);
        return;
      }

      const templateUrl = new URL('/api/project-file/template', window.location.origin);
      templateUrl.searchParams.set('projectId', activeProjectId || 'project-browser-preview');
      templateUrl.searchParams.set('projectName', projectName);
      if (client) templateUrl.searchParams.set('client', client);
      if (address) templateUrl.searchParams.set('address', address);

      try {
        const response = await fetch(templateUrl.toString());
        if (!response.ok) {
          throw new Error(`Unable to load project file (${response.status})`);
        }
        const payload = await response.json();
        if (!payload?.projectFile) {
          throw new Error('Malformed response from project template endpoint.');
        }

        projectContext.projectFile = payload.projectFile;
        projectContext.uploadStatus = uploadStatus;
        renderTree(payload.projectFile, projectContext);
      } catch (err) {
        renderError(`Project browser failed to load: ${err.message}`);
      }
    }

    initialize();
  </script>
</body>
</html>

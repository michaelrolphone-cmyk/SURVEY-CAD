<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EquipmentLog — Equipment Setup Logs</title>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: Inter, system-ui, sans-serif; background: #0b1220; color: #e2e8f0; }
    .layout { display: flex; flex-direction: column; min-height: 100vh; }
    header { padding: 18px 24px; border-bottom: 1px solid #22314f; background: #0f1a2e; }
    header h1 { margin: 0 0 4px; font-size: 1.25rem; }
    header p { margin: 0; color: #9fb0cc; font-size: 0.875rem; }
    main { flex: 1; padding: 20px 24px; max-width: 960px; width: 100%; margin: 0 auto; }

    .form-section { background: #0f1a2e; border: 1px solid #22314f; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
    .form-section h2 { margin: 0 0 16px; font-size: 1rem; color: #60a5fa; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group.full-width { grid-column: 1 / -1; }
    label { font-size: 0.8rem; color: #9fb0cc; font-weight: 500; }
    input, select, textarea { border: 1px solid #2a3f62; border-radius: 8px; background: #12203a; color: #e2e8f0; padding: 9px 11px; font-size: 0.875rem; font-family: inherit; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.25); }
    textarea { resize: vertical; min-height: 60px; }

    .toolbar { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    button { border: 1px solid #2a3f62; border-radius: 8px; background: #12203a; color: #e2e8f0; padding: 9px 14px; cursor: pointer; font-size: 0.85rem; font-family: inherit; }
    button:hover { background: #1a2d4a; }
    .primary { background: #2563eb; border-color: #3b82f6; }
    .primary:hover { background: #1d4ed8; }
    .danger { background: #7f1d1d; border-color: #dc2626; }
    .danger:hover { background: #991b1b; }

    .log-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .log-card { background: #0f1a2e; border: 1px solid #22314f; border-radius: 10px; padding: 16px; cursor: pointer; transition: border-color 0.15s; }
    .log-card:hover { border-color: #3b82f6; }
    .log-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .log-card-title { font-weight: 600; font-size: 0.95rem; }
    .log-card-time { font-size: 0.78rem; color: #9fb0cc; }
    .log-card-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 6px; font-size: 0.82rem; }
    .log-card-field { color: #9fb0cc; }
    .log-card-field strong { color: #e2e8f0; font-weight: 500; }

    .empty-state { text-align: center; padding: 60px 20px; color: #64748b; }
    .empty-state p { margin: 8px 0; }

    .badge { display: inline-block; background: #1e3a5f; color: #60a5fa; border-radius: 6px; padding: 2px 8px; font-size: 0.75rem; font-weight: 600; }
    .teardown-btn { background: #1e3a5f; border-color: #3b82f6; color: #60a5fa; }
    .teardown-btn:hover { background: #2a4a6f; }
    .teardown-btn:disabled { opacity: 0.5; cursor: default; background: #12203a; border-color: #2a3f62; color: #64748b; }
    .hidden { display: none; }

    .export-bar { display: flex; gap: 8px; margin-top: 20px; padding-top: 16px; border-top: 1px solid #22314f; }

    @media (max-width: 640px) {
      .form-grid { grid-template-columns: 1fr; }
      main { padding: 14px; }
    }
  </style>
  <script type="module" src="/src/browser-localstorage-sync.js"></script>
</head>
<body>
  <div class="layout">
    <header>
      <h1>EquipmentLog</h1>
      <p>Record and manage equipment setup logs for each survey session.</p>
    </header>

    <main>
      <!-- Log List -->
      <div id="logList" class="log-list"></div>
      <div id="emptyState" class="empty-state hidden">
        <p><strong>No equipment logs yet.</strong></p>
        <p>Fill in the form above to record your first setup.</p>
      </div>
      <!-- Entry Form -->
      <div id="formSection" class="form-section">
        <h2 id="formHeading">New Setup Log</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="rodman">Rodman</label>
            <select id="rodman"></select>
          </div>
          <div class="form-group">
            <label for="equipmentHeight">Equipment Height</label>
            <input id="equipmentHeight" type="text" placeholder="e.g. 5.2 ft" />
          </div>
          <div class="form-group">
            <label for="referencePoint">Reference Point</label>
            <input id="referencePoint" type="text" placeholder="e.g. MON 1042" />
          </div>
          <div class="form-group">
            <label for="setupTime">Setup Time</label>
            <input id="setupTime" type="datetime-local" />
          </div>
          <div class="form-group">
            <label for="teardownTime">Teardown Time</label>
            <input id="teardownTime" type="datetime-local" />
          </div>
          <div class="form-group">
            <label for="jobFileName">Job File Name</label>
            <input id="jobFileName" type="text" placeholder="e.g. 2024-0312_BoiseSurvey.job" />
          </div>
          <div class="form-group">
            <label for="pointFileAttachment">Point File Attachment</label>
            <input id="pointFileAttachment" type="file" accept=".csv,text/csv,.txt,text/plain" />
          </div>
          <div class="form-group">
            <label for="equipmentType">Equipment Type</label>
            <select id="equipmentType">
              <option value="">Select equipment…</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label for="notes">Notes</label>
            <textarea id="notes" placeholder="Additional observations, conditions, or setup details…"></textarea>
          </div>
        </div>
        <div style="margin-top: 14px; display: flex; gap: 8px;">
          <button id="saveBtn" class="primary" type="button">Save Log</button>
          <button id="cancelBtn" type="button" class="hidden">Cancel</button>
        </div>
      </div>

      
      <!-- Toolbar -->
      <div class="toolbar">
        <button id="newLogBtn" class="primary" type="button">New Log</button>
        <button id="exportCsvBtn" type="button">Export CSV</button>
        <button id="exportJsonBtn" type="button">Export JSON</button>
        <button id="clearAllBtn" class="danger" type="button">Clear All</button>
      </div>

    </main>
  </div>

  <script type="module">
    import { buildEquipmentLogOptions } from './src/equipment-log-options.js';
    import { buildEquipmentLogPointFilePayload } from './src/equipment-log-point-files.js';

    const STORAGE_KEY = 'surveyfoundryEquipmentLogs';
    const CREW_PROFILES_STORAGE_KEY = 'surveyfoundryCrewProfiles';
    const EQUIPMENT_STORAGE_KEY = 'surveyfoundryEquipmentInventory';

    // API config
    const EQUIPMENT_LOGS_API_URL = '/api/equipment-logs';
    const CREW_API_URL = '/api/crew';
    const EQUIPMENT_API_URL = '/api/equipment';
    const activeProjectId = new URLSearchParams(window.location.search).get('activeProjectId') || '';

    const fields = {
      rodman: document.getElementById('rodman'),
      equipmentHeight: document.getElementById('equipmentHeight'),
      referencePoint: document.getElementById('referencePoint'),
      setupTime: document.getElementById('setupTime'),
      teardownTime: document.getElementById('teardownTime'),
      jobFileName: document.getElementById('jobFileName'),
      pointFileAttachment: document.getElementById('pointFileAttachment'),
      equipmentType: document.getElementById('equipmentType'),
      notes: document.getElementById('notes'),
    };

    const formHeading = document.getElementById('formHeading');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const newLogBtn = document.getElementById('newLogBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportJsonBtn = document.getElementById('exportJsonBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const logListEl = document.getElementById('logList');
    const emptyStateEl = document.getElementById('emptyState');

    let logs = [];
    let crew = [];
    let equipment = [];
    let editingId = null;

    function renderCrewList() {
        let crewItems = crew.map((member)=> `<option value="${member.id}">${member.firstName} ${member.lastName}</option>`);
        rodman.innerHTML = crewItems.join("\n");
    }
    function loadLogs() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        logs = raw ? JSON.parse(raw) : [];
      } catch {
        logs = [];
      }
    }
    function loadCrew() {
      try {
        const raw = localStorage.getItem(CREW_PROFILES_STORAGE_KEY);
        crew = raw ? JSON.parse(raw) : [];
      } catch {
        crew = [];
      }
    }

    function loadEquipment() {
      try {
        const raw = localStorage.getItem(EQUIPMENT_STORAGE_KEY);
        equipment = raw ? JSON.parse(raw) : [];
      } catch {
        equipment = [];
      }
    }

    function renderEquipmentOptions(selectedValue = fields.equipmentType.value || '') {
      const options = buildEquipmentLogOptions(equipment);
      const hasSelectedValue = !!selectedValue;
      const selectedMissing = hasSelectedValue && !options.includes(selectedValue);
      const values = selectedMissing ? [...options, selectedValue] : options;
      fields.equipmentType.innerHTML = [
        '<option value="">Select equipment…</option>',
        ...values.map((value) => `<option value="${esc(value)}">${esc(value)}</option>`),
      ].join('');
      if (hasSelectedValue) fields.equipmentType.value = selectedValue;
    }

    function saveLogs() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
    }

    /* ── API helpers ── */
    function mergeById(localList, serverList) {
      const out = new Map();
      for (const item of (localList || [])) {
        if (item && item.id) out.set(item.id, item);
      }
      for (const item of (serverList || [])) {
        if (item && item.id) out.set(item.id, { ...(out.get(item.id) || {}), ...item });
      }
      return Array.from(out.values());
    }

    function normalizeServerLogList(json) {
      if (Array.isArray(json)) return json;
      if (Array.isArray(json?.logs)) return json.logs;
      if (Array.isArray(json?.data)) return json.data;
      return null;
    }

    function normalizeServerLog(json) {
      if (json && typeof json === 'object') {
        if (json.log && typeof json.log === 'object' && json.log.id) return json.log;
        if (json.data && typeof json.data === 'object') return json.data;
        if (json.id) return json;
      }
      return null;
    }

    async function postEquipmentLog(log) {
      const res = await fetch(EQUIPMENT_LOGS_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(log),
      });
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`POST ${EQUIPMENT_LOGS_API_URL} failed (${res.status}) ${text}`.trim());
      }
      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) return null;
      return await res.json();
    }

    function esc(v = '') {
      return String(v).replace(/[&<>"']/g, (c) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;',
      }[c]));
    }

    function formatDateTime(iso) {
      if (!iso) return '—';
      try {
        const d = new Date(iso);
        return d.toLocaleString(undefined, {
          year: 'numeric', month: 'short', day: 'numeric',
          hour: '2-digit', minute: '2-digit',
        });
      } catch {
        return iso;
      }
    }

    function clearForm() {
      Object.values(fields).forEach((el) => { el.value = ''; });
      editingId = null;
      formHeading.textContent = 'New Setup Log';
      cancelBtn.classList.add('hidden');
    }

    function populateForm(log) {
      fields.rodman.value = log.rodman || '';
      fields.equipmentHeight.value = log.equipmentHeight || '';
      fields.referencePoint.value = log.referencePoint || '';
      fields.setupTime.value = log.setupTime || '';
      fields.teardownTime.value = log.teardownTime || '';
      fields.jobFileName.value = log.jobFileName || '';
      fields.pointFileAttachment.value = '';
      renderEquipmentOptions(log.equipmentType || '');
      fields.equipmentType.value = log.equipmentType || '';
      fields.notes.value = log.notes || '';
      editingId = log.id;
      formHeading.textContent = 'Edit Setup Log';
      cancelBtn.classList.remove('hidden');
      fields.rodman.focus();
    }
    function renderLogs() {
      
      renderCrewList();
      renderEquipmentOptions();
      if (logs.length === 0) {
        logListEl.innerHTML = '';
        emptyStateEl.classList.remove('hidden');
        return;
      }

      emptyStateEl.classList.add('hidden');

      const sorted = [...logs].sort((a, b) => {
        const ta = a.createdAt || '';
        const tb = b.createdAt || '';
        return tb.localeCompare(ta);
      });
    

      logListEl.innerHTML = sorted.map((log) => `
        <div class="log-card" data-id="${log.id}">
          <div class="log-card-header">
            <span class="log-card-title">${esc(log.jobFileName) || 'Untitled Log'}</span>
            <span class="log-card-time">${formatDateTime(log.createdAt)}</span>
          </div>
          <div class="log-card-details">
            <div class="log-card-field"><strong>Rodman:</strong> ${esc(log.rodman) || '—'}</div>
            <div class="log-card-field"><strong>Height:</strong> ${esc(log.equipmentHeight) || '—'}</div>
            <div class="log-card-field"><strong>Ref Point:</strong> ${esc(log.referencePoint) || '—'}</div>
            <div class="log-card-field"><strong>Setup Time:</strong> ${formatDateTime(log.setupTime)}</div>
            <div class="log-card-field"><strong>Teardown Time:</strong> ${formatDateTime(log.teardownTime)}</div>
            ${log.equipmentType ? `<div class="log-card-field"><span class="badge">${esc(log.equipmentType)}</span></div>` : ''}
          </div>
          ${log.pointFileName ? `<div style="margin-top:8px;font-size:0.82rem;color:#9fb0cc;"><strong>Point File:</strong> ${esc(log.pointFileName)}</div>` : ''}
          ${log.notes ? `<div style="margin-top:8px;font-size:0.82rem;color:#9fb0cc;">${esc(log.notes)}</div>` : ''}
          <div style="margin-top:10px;display:flex;gap:6px;">
            <button class="teardown-btn${log.teardownTime ? ' teardown-btn' : ''}" data-id="${log.id}" data-action="teardown" type="button"${log.teardownTime ? ' disabled' : ''}>${log.teardownTime ? 'Teardown Recorded' : 'Record Teardown'}</button>
            <button class="edit-btn" data-id="${log.id}" type="button">Edit</button>
            <button class="delete-btn danger" data-id="${log.id}" type="button">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function getFormData() {
      return {
        rodman: fields.rodman.value.trim(),
        equipmentHeight: fields.equipmentHeight.value.trim(),
        referencePoint: fields.referencePoint.value.trim(),
        setupTime: fields.setupTime.value,
        teardownTime: fields.teardownTime.value,
        jobFileName: fields.jobFileName.value.trim(),
        equipmentType: fields.equipmentType.value,
        notes: fields.notes.value.trim(),
      };
    }


    function normalizeServerPointFile(json) {
      if (json && typeof json === 'object') {
        if (json.pointFile && typeof json.pointFile === 'object') return json.pointFile;
      }
      return null;
    }

    async function uploadAttachmentToProjectPointFiles(log) {
      const file = fields.pointFileAttachment.files?.[0];
      if (!file) return null;
      if (!activeProjectId) {
        alert('Attach point files from Equipment Log requires an active project (open with ?activeProjectId=<project-id>).');
        return null;
      }

      const text = await file.text();
      const payload = buildEquipmentLogPointFilePayload({
        projectId: activeProjectId,
        fileName: file.name,
        text,
        log,
      });
      if (!payload) return null;

      const response = await fetch(`/api/projects/${encodeURIComponent(activeProjectId)}/point-files`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!response.ok) {
        const err = await response.text().catch(() => '');
        throw new Error(`Point file upload failed (${response.status}) ${err}`.trim());
      }
      const json = await response.json().catch(() => ({}));
      return normalizeServerPointFile(json);
    }
    saveBtn.addEventListener('click', async () => {
      const data = getFormData();

      if (!data.rodman && !data.jobFileName) {
        fields.rodman.focus();
        return;
      }

      const nowIso = new Date().toISOString();
      const wasEditing = !!editingId;

      let attachmentSummary = null;
      try {
        attachmentSummary = await uploadAttachmentToProjectPointFiles(data);
      } catch (error) {
        alert(error.message || 'Unable to attach the selected point file.');
        return;
      }

      // UI lock
      const prevText = saveBtn.textContent;
      saveBtn.disabled = true;
      saveBtn.textContent = wasEditing ? 'Saving…' : 'Saving & Syncing…';

      try {
        if (wasEditing) {
          const idx = logs.findIndex((l) => l.id === editingId);
          let updatedLog = null;
          if (idx !== -1) {
            updatedLog = {
              ...logs[idx],
              ...data,
              ...(attachmentSummary ? {
                pointFileId: attachmentSummary.pointFileId || '',
                pointFileName: attachmentSummary.pointFileName || '',
                pointFileProjectId: activeProjectId || '',
              } : {}),
              updatedAt: nowIso,
            };
            logs[idx] = updatedLog;
          }
          saveLogs();
          clearForm();
          renderLogs();

          if (updatedLog) {
            try {
              const apiJson = await postEquipmentLog(updatedLog);
              const serverLog = normalizeServerLog(apiJson);
              if (serverLog && serverLog.id) {
                const mergedIdx = logs.findIndex((entry) => entry.id === serverLog.id);
                if (mergedIdx !== -1) {
                  logs[mergedIdx] = { ...logs[mergedIdx], ...serverLog };
                  saveLogs();
                  renderLogs();
                }
              }
            } catch (err) {
              console.warn('Equipment log edit POST failed; kept local copy:', err);
            }
          }
          return;
        }

        // NEW log: create local record first (fast)
        const localId = crypto.randomUUID();
        const newLocal = {
          id: localId,
          ...data,
          ...(attachmentSummary ? {
            pointFileId: attachmentSummary.pointFileId || '',
            pointFileName: attachmentSummary.pointFileName || '',
            pointFileProjectId: activeProjectId || '',
          } : {}),
          createdAt: nowIso,
          updatedAt: nowIso,
        };
        logs.push(newLocal);
        saveLogs();
        clearForm();
        renderLogs();

        // Then POST to API
        try {
          const apiJson = await postEquipmentLog(newLocal);

          const serverList = normalizeServerLogList(apiJson);
          if (serverList) {
            logs = mergeById(logs, serverList);
            saveLogs();
            renderLogs();
            return;
          }

          const serverLog = normalizeServerLog(apiJson);
          if (serverLog && serverLog.id) {
            const localIdx = logs.findIndex(l => l.id === localId);
            if (localIdx !== -1) {
              if (serverLog.id !== localId) {
                const merged = { ...logs[localIdx], ...serverLog };
                logs.splice(localIdx, 1);
                logs.push(merged);
              } else {
                logs[localIdx] = { ...logs[localIdx], ...serverLog };
              }
              saveLogs();
              renderLogs();
            }
          }
        } catch (err) {
          console.warn('Equipment log POST failed; kept local copy:', err);
        }
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = prevText;
      }
    });

    cancelBtn.addEventListener('click', () => {
      clearForm();
    });

    newLogBtn.addEventListener('click', () => {
      clearForm();
      fields.rodman.focus();
    });

    logListEl.addEventListener('click', (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;

      const id = target.dataset.id;
      if (!id) return;

      if (target.dataset.action === 'teardown') {
        const log = logs.find((l) => l.id === id);
        if (log && !log.teardownTime) {
          const now = new Date();
          const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
          log.teardownTime = local;
          log.updatedAt = now.toISOString();
          saveLogs();
          renderLogs();
          // Sync teardown to API
          postEquipmentLog(log).catch(err => {
            console.warn('Equipment log teardown POST failed:', err);
          });
        }
      } else if (target.classList.contains('edit-btn')) {
        const log = logs.find((l) => l.id === id);
        if (log) populateForm(log);
      } else if (target.classList.contains('delete-btn')) {
        logs = logs.filter((l) => l.id !== id);
        saveLogs();
        if (editingId === id) clearForm();
        renderLogs();
      }
    });

    clearAllBtn.addEventListener('click', () => {
      if (!confirm('Delete all equipment logs? This cannot be undone.')) return;
      logs = [];
      saveLogs();
      clearForm();
      renderLogs();
    });

    exportCsvBtn.addEventListener('click', () => {
      if (logs.length === 0) return;
      const headers = ['Job File', 'Rodman', 'Equipment Height', 'Reference Point', 'Setup Time', 'Teardown Time', 'Equipment Type', 'Point File', 'Notes', 'Created At'];
      const rows = logs.map((l) => [
        l.jobFileName, l.rodman, l.equipmentHeight, l.referencePoint,
        l.setupTime, l.teardownTime, l.equipmentType, l.pointFileName, l.notes, l.createdAt,
      ].map((v) => `"${String(v || '').replace(/"/g, '""')}"`).join(','));

      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `equipment-logs-${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    exportJsonBtn.addEventListener('click', () => {
      if (logs.length === 0) return;
      const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `equipment-logs-${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });
    window.addEventListener('surveyfoundry-localstorage-sync', () => {
      loadCrew();
      loadLogs();
      loadEquipment();
      renderLogs();
    });

    async function fetchLatestFromApi() {
      try {
        const [crewRes, logsRes, equipmentRes] = await Promise.all([
          fetch(CREW_API_URL),
          fetch(EQUIPMENT_LOGS_API_URL),
          fetch(EQUIPMENT_API_URL),
        ]);
        let updated = false;
        if (crewRes.ok) {
          const crewData = await crewRes.json();
          const serverCrew = Array.isArray(crewData?.crew) ? crewData.crew : [];
          if (serverCrew.length > 0) {
            // Merge instead of replacing (prevents wiping local-only items)
            crew = mergeById(crew, serverCrew);
            localStorage.setItem(CREW_PROFILES_STORAGE_KEY, JSON.stringify(crew));
            updated = true;
          }
        }
        if (logsRes.ok) {
          const logsData = await logsRes.json();
          const serverLogs = Array.isArray(logsData?.logs) ? logsData.logs : [];
          if (serverLogs.length > 0) {
            // Merge instead of replacing (prevents wiping local-only items)
            logs = mergeById(logs, serverLogs);
            saveLogs();
            updated = true;
          }
        }
        if (equipmentRes.ok) {
          const equipmentData = await equipmentRes.json();
          const serverEquipment = Array.isArray(equipmentData?.equipment) ? equipmentData.equipment : [];
          if (serverEquipment.length > 0) {
            equipment = mergeById(equipment, serverEquipment);
            localStorage.setItem(EQUIPMENT_STORAGE_KEY, JSON.stringify(equipment));
            updated = true;
          }
        }
        if (updated) renderLogs();
      } catch {
        // API unavailable, continue with localStorage data.
      }
    }

    loadCrew();
    loadLogs();
    loadEquipment();
    renderLogs();
    fetchLatestFromApi();
  </script>
</body>
</html>

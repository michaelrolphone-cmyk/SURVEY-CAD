<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UtilitiesPack — Utility Record Bundle</title>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: Inter, system-ui, sans-serif; background: #0b1220; color: #e2e8f0; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 6px; }
    p { color: #9fb0cc; }
    form { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; margin: 20px 0; }
    input, button { border-radius: 8px; border: 1px solid #2a3f62; background: #12203a; color: #e2e8f0; padding: 10px 12px; }
    button { cursor: pointer; background: #1d4ed8; border-color: #2563eb; }
    button.secondary { background: #243247; border-color: #334155; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    .status { min-height: 20px; color: #93c5fd; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom: 1px solid #243247; padding: 8px; text-align: left; font-size: 13px; }
    .small { font-size: 12px; color: #94a3b8; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>UtilitiesPack</h1>
    <p>Fetch utility records for an address and export Idaho Power points with state-plane coordinates.</p>

    <form id="lookupForm">
      <input id="addressInput" placeholder="100 Main St, Boise, ID" required />
      <button id="lookupButton" type="submit">Fetch Utilities</button>
      <button id="exportButton" class="secondary" type="button" disabled>Export Power CSV</button>
    </form>

    <div class="status" id="status"></div>
    <div class="small" id="meta"></div>

    <table>
      <thead>
        <tr>
          <th>Source</th><th>Provider</th><th>Code</th><th>Lon</th><th>Lat</th><th>East</th><th>North</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>

  <script type="module">
    import { loadUtilitiesByAddress } from './src/browser-survey-client.js';

    const state = { address: '', utilities: [], outSR: 2243 };
    const form = document.getElementById('lookupForm');
    const input = document.getElementById('addressInput');
    const status = document.getElementById('status');
    const meta = document.getElementById('meta');
    const body = document.getElementById('resultsBody');
    const exportButton = document.getElementById('exportButton');
    const lookupButton = document.getElementById('lookupButton');

    function escapeHtml(value) {
      return String(value || '').replace(/[&<>"']/g, (ch) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[ch]));
    }

    function render() {
      body.innerHTML = state.utilities.map((utility) => {
        const projected = utility?.projected || {};
        const location = utility?.location || {};
        return `<tr>
          <td>${escapeHtml(utility.source || '')}</td>
          <td>${escapeHtml(utility.provider || '')}</td>
          <td>${escapeHtml(utility.code || utility.name || '')}</td>
          <td>${Number(location.lon).toFixed(7)}</td>
          <td>${Number(location.lat).toFixed(7)}</td>
          <td>${Number(projected.east).toFixed(3)}</td>
          <td>${Number(projected.north).toFixed(3)}</td>
        </tr>`;
      }).join('');
      exportButton.disabled = !state.utilities.some((utility) => String(utility.source || '').toLowerCase() === 'power');
      meta.textContent = `${state.utilities.length} utility record(s) loaded in EPSG:${state.outSR}.`;
    }

    function buildPowerCsv() {
      const rows = [['name', 'northing', 'easting', 'elevation', 'code', 'description']];
      state.utilities
        .filter((utility) => String(utility.source || '').toLowerCase() === 'power')
        .forEach((utility, index) => {
          const projected = utility.projected || {};
          const code = utility.code || utility.name || 'UTIL';
          rows.push([
            utility.name || `POWER_${index + 1}`,
            Number(projected.north || 0).toFixed(3),
            Number(projected.east || 0).toFixed(3),
            '',
            code,
            utility.provider || utility.source || '',
          ]);
        });
      return rows.map((row) => row.map((value) => `"${String(value).replaceAll('"', '""')}"`).join(',')).join('\n');
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const address = input.value.trim();
      if (!address) return;
      state.address = address;
      status.textContent = 'Loading utility records…';
      lookupButton.disabled = true;
      try {
        state.utilities = await loadUtilitiesByAddress(address, { outSR: state.outSR, sources: ['power'] });
        status.textContent = 'Utility records loaded.';
      } catch (error) {
        state.utilities = [];
        status.textContent = `Lookup failed: ${error.message || error}`;
      } finally {
        lookupButton.disabled = false;
        render();
      }
    });

    exportButton.addEventListener('click', () => {
      const csv = buildPowerCsv();
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `utilitiespack_power_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>

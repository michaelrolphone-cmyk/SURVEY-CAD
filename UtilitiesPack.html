<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UtilitiesPack — Utility Record Bundle</title>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: Inter, system-ui, sans-serif; background: #0b1220; color: #e2e8f0; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 6px; }
    p { color: #9fb0cc; }
    form { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; margin: 20px 0; }
    input, button { border-radius: 8px; border: 1px solid #2a3f62; background: #12203a; color: #e2e8f0; padding: 10px 12px; }
    button { cursor: pointer; background: #1d4ed8; border-color: #2563eb; }
    button.secondary { background: #243247; border-color: #334155; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    .iconButton {
      min-width: 88px;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 8px 10px;
      line-height: 1;
    }
    .iconButton svg { display: block; }
    .iconWrap { position: relative; width: 24px; height: 24px; }
    .iconFile { color: #cbd5e1; }
    .iconDownload {
      position: absolute;
      right: -2px;
      bottom: -2px;
      color: #93c5fd;
      filter: drop-shadow(0 0 2px rgba(15, 23, 42, 0.9));
    }
    .iconSubtitle { font-size: 11px; color: #cbd5e1; letter-spacing: 0.03em; }
    .status { min-height: 20px; color: #93c5fd; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom: 1px solid #243247; padding: 8px; text-align: left; font-size: 13px; }
    .small { font-size: 12px; color: #94a3b8; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>UtilitiesPack</h1>
    <p>Fetch utility records for an address and export Idaho Power points with state-plane coordinates.</p>

    <form id="lookupForm">
      <input id="addressInput" placeholder="100 Main St, Boise, ID" required />
      <button id="lookupButton" type="submit">Fetch Utilities</button>
      <button id="exportButton" class="secondary iconButton" type="button" aria-label="Export power CSV" title="Export power CSV" disabled>
        <span class="iconWrap" aria-hidden="true">
          <svg class="iconFile" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H7C5.89543 2 5 2.89543 5 4V20C5 21.1046 5.89543 22 7 22H17C18.1046 22 19 21.1046 19 20V7L14 2Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M14 2V7H19" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8.5 11.5H15.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M8.5 14.5H15.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
          </svg>
          <svg class="iconDownload" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 1.5V8" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M3.75 5.75L6 8L8.25 5.75" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M2 10H10" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
          </svg>
        </span>
        <span class="iconSubtitle">Export</span>
      </button>
    </form>

    <div class="status" id="status"></div>
    <div class="small" id="meta"></div>

    <table>
      <thead>
        <tr>
          <th>Source</th><th>Provider</th><th>Code</th><th>Lon</th><th>Lat</th><th>East</th><th>North</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>

  <script type="module">
    import { loadUtilitiesByAddress } from './src/browser-survey-client.js';

    const state = { address: '', utilities: [], outSR: 2243 };
    const form = document.getElementById('lookupForm');
    const input = document.getElementById('addressInput');
    const status = document.getElementById('status');
    const meta = document.getElementById('meta');
    const body = document.getElementById('resultsBody');
    const exportButton = document.getElementById('exportButton');
    const lookupButton = document.getElementById('lookupButton');

    function escapeHtml(value) {
      return String(value || '').replace(/[&<>"']/g, (ch) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[ch]));
    }

    function render() {
      body.innerHTML = state.utilities.map((utility) => {
        const projected = utility?.projected || {};
        const location = utility?.location || {};
        return `<tr>
          <td>${escapeHtml(utility.source || '')}</td>
          <td>${escapeHtml(utility.provider || '')}</td>
          <td>${escapeHtml(utility.code || utility.name || '')}</td>
          <td>${Number(location.lon).toFixed(7)}</td>
          <td>${Number(location.lat).toFixed(7)}</td>
          <td>${Number(projected.east).toFixed(3)}</td>
          <td>${Number(projected.north).toFixed(3)}</td>
        </tr>`;
      }).join('');
      exportButton.disabled = !state.utilities.some((utility) => String(utility.source || '').toLowerCase() === 'power');
      meta.textContent = `${state.utilities.length} utility record(s) loaded in EPSG:${state.outSR}.`;
    }

    function buildPowerCsv() {
      const rows = [['id', 'source', 'provider', 'code', 'name', 'lon', 'lat', 'east', 'north', 'outSR']];
      state.utilities
        .filter((utility) => String(utility.source || '').toLowerCase() === 'power')
        .forEach((utility) => {
          const projected = utility.projected || {};
          const location = utility.location || {};
          rows.push([
            utility.id || '',
            utility.source || '',
            utility.provider || '',
            utility.code || '',
            utility.name || '',
            Number(location.lon || 0).toFixed(8),
            Number(location.lat || 0).toFixed(8),
            Number(projected.east || 0).toFixed(3),
            Number(projected.north || 0).toFixed(3),
            String(projected?.spatialReference?.wkid || state.outSR),
          ]);
        });
      return rows.map((row) => row.map((value) => `"${String(value).replaceAll('"', '""')}"`).join(',')).join('\n');
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const address = input.value.trim();
      if (!address) return;
      state.address = address;
      status.textContent = 'Loading utility records…';
      lookupButton.disabled = true;
      try {
        state.utilities = await loadUtilitiesByAddress(address, { outSR: state.outSR, sources: ['power'] });
        status.textContent = 'Utility records loaded.';
      } catch (error) {
        state.utilities = [];
        status.textContent = `Lookup failed: ${error.message || error}`;
      } finally {
        lookupButton.disabled = false;
        render();
      }
    });

    exportButton.addEventListener('click', () => {
      const csv = buildPowerCsv();
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `utilitiespack_power_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
